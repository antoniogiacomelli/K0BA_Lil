<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<meta name="author" content="Kernel 0 For Embedded Applications (v0.3.1-L)">
<title>K0BA: The Real-Time Kernel "0"</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
</head>
<body class="docbook toc2 toc-left data-line-1">
<div id="header">
<h1><strong>K<em>0</em>BA:</strong> The Real-Time Kernel "<em>0</em>"</h1>
<div class="details">
<span id="author" class="author">Kernel 0 For Embedded Applications (v0.3.1-L)</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#the_kernel_on_a_glance"><strong>The kernel on a glance</strong></a>
<ul class="sectlevel1">
<li><a href="#the_design_approach">1. The design approach</a>
<ul class="sectlevel2">
<li><a href="#k0_is_different">1.1. K0 is different</a></li>
<li><a href="#a_real_time_executive">1.2. <strong>A Real-Time <em>Executive</em></strong></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#core_mechanisms"><strong><em>Core Mechanisms</em></strong></a>
<ul class="sectlevel1">
<li><a href="#data_structures">1. Data Structures</a>
<ul class="sectlevel2">
<li><a href="#task_control_block">1.1. Task Control Block</a></li>
<li><a href="#the_scheduling_algorithm">1.2. The scheduling algorithm</a></li>
<li><a href="#scheduler_determinism">1.3. Scheduler Determinism</a></li>
<li><a href="#common_scheduling_pitfalls">1.4. Common scheduling pitfalls</a></li>
</ul>
</li>
<li><a href="#timers">2. <strong>Timers</strong></a>
<ul class="sectlevel2">
<li><a href="#sleep_timers">2.1. Sleep Timers</a></li>
<li><a href="#blocking_time_out">2.2. Blocking Time-out</a></li>
<li><a href="#callout_timers">2.3. Callout Timers</a></li>
</ul>
</li>
<li><a href="#system_tick">3. <strong>System Tick</strong></a></li>
<li><a href="#memory_allocator">4. <strong>Memory Allocator</strong></a>
<ul class="sectlevel2">
<li><a href="#memory_allocator_determinism">4.1. Memory Allocator Determinism</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#inter_task_communication_itc"><strong><em>Inter-task communication (ITC)</em></strong></a>
<ul class="sectlevel1">
<li><a href="#synchronisation_mechanisms">1. <strong>Synchronisation mechanisms</strong></a>
<ul class="sectlevel2">
<li><a href="#events_sleepwake">1.1. Events (Sleep/Wake)</a></li>
<li><a href="#semaphores">1.2. Semaphores</a></li>
<li><a href="#event_flags">1.3. Event Flags</a></li>
</ul>
</li>
<li><a href="#message_passing">2. <strong>Message Passing</strong></a>
<ul class="sectlevel2">
<li><a href="#mailbox_exchange">2.1. Mailbox (Exchange)</a></li>
<li><a href="#message_queues">2.2. Message Queues</a></li>
<li><a href="#pump_drop_buffers">2.3. Pump-Drop Buffers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#usage_patterns"><strong>Usage Patterns</strong></a>
<ul class="sectlevel1">
<li><a href="#extended_rendezvous_1">1. <em>Extended rendezvous #1</em></a></li>
<li><a href="#extended_rendezvous_2">2. <em>Extended rendezvous</em> #2</a></li>
<li><a href="#monitor_0_barrier">3. <em>Monitor</em> #0 (Barrier)</a></li>
<li><a href="#monitor_1_turnstile">4. <em>Monitor</em> #1 (Turnstile)</a></li>
<li><a href="#multi_condition_notification_0">5. <em>Multi-condition Notification</em> #0</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock note data-line-5">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This document is a high-level system description. Except for code snippets, features are described with a generic API. Kernel API details can be found at the project: <a href="https://github.com/antoniogiacomelli/K0BA_Lil">repository</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<h1 id="the_kernel_on_a_glance" class="sect0 data-line-14"><strong>The kernel on a glance</strong></h1>
<div class="sect1 data-line-16">
<h2 id="the_design_approach">1. The design approach</h2>
<div class="sectionbody">
<div class="paragraph data-line-18">
<p>In my early teens, when I was first introduced to UNIX-like operating systems, I barely knew any programming, yet I was intrigued by the idea that UNIX was an operating system 'for programmers. Eventually, I understood. <em>K0BA</em> is rooted in this understanding.</p>
</div>
<div class="paragraph data-line-20">
<p><em>K<strong>0</strong></em> aims to showcase the idea that embedded system programming—more than any other type of systems programming—does not benefit from an application framework approach. Maintaining complete control is essential in embedded systems to ensure efficiency and predictable behaviour.</p>
</div>
<div class="paragraph data-line-22">
<p>When composed to build more complex functionality, a balanced set of simple primitives provides greater controllability and observability than any opaque, complex feature.</p>
</div>
<div class="paragraph data-line-24">
<p>This is a timeless lesson from UNIX—one that modern RTOSes often neglect, despite its increasing relevance in embedded systems.</p>
</div>
<div class="sect2 data-line-26">
<h3 id="k0_is_different">1.1. K0 is different</h3>
<div class="paragraph data-line-28">
<p>Low-end MCUs based on the supported architecture (ARMv7M) often do not come with a Memory Protection Unit - so privilege levels are limited to the CPU scope: instructions and registers. This level of safety does not compensate for the overhead of system calls, as they harm determinism and responsiveness.</p>
</div>
<div class="paragraph data-line-30">
<p>That said, K0BA is not currently designed with IoT in mind. However, work is underway on a security-focused edition. The edition presented here is optimised for determinism, responsiveness, and a minimal footprint.</p>
</div>
<div class="paragraph data-line-32">
<p>As of today, <em>K0</em> is a one-man effort. Thus, supporting a wide range of CPU architectures is not on the radar. The plan is to support a few with quality.</p>
</div>
</div>
<div class="sect2 data-line-34">
<h3 id="a_real_time_executive">1.2. <strong>A Real-Time <em>Executive</em></strong></h3>
<div class="paragraph data-line-36">
<p>If no more details are to be provided, the kernel has a top and a bottom layer - on the top, the <em>Executive</em>  manages the resources needed by the application; on the bottom, the <em>Low-level Scheduler</em> works as a software extension of the CPU.</p>
</div>
<div class="paragraph data-line-38">
<p>Together, they implement the <em>Task</em> concept and provide the primitives for a programmable multitasking environment.</p>
</div>
<div class="imageblock data-line-40">
<div class="content">
<img src="images/images/layeredkernel.png" alt="layeredkernel">
</div>
</div>
<div class="paragraph data-line-42">
<p>A process is composed of an execution image and an address space. A thread is a logical sequence of instructions. Several threads coexist in the same address space within the same process.</p>
</div>
<div class="paragraph data-line-44">
<p>On the embedded realm, probably because we lack a better abstraction, we use multithreading to fine-tune our load balance and, therefore, responsiveness to achieve real-time.</p>
</div>
<div class="paragraph data-line-46">
<p>This is an arrangement: instead of having a single super-loop, we have many, each running on its own execution stack.</p>
</div>
<div class="paragraph data-line-48">
<p>This arrangement yields an operating system entity to handle—a (logical) <em>Execution Unit</em>: in K0, we name it a <em>Task</em> (the terms task and thread are used interchangeably in this document).</p>
</div>
<div class="paragraph data-line-50">
<p>The K0 multitasking engine is wired to a single process on a single address space - as the majority of small kernels you see around (regardless the claims of being <em>micro</em>, <em>nano</em> or <em>pico</em> kernels).</p>
</div>
<div class="sect3 data-line-52">
<h4 id="the_coding_style">1.2.1. The coding style</h4>
<div class="paragraph data-line-54">
<p>K0BA’s coding style may seem "inelegant" to those accustomed to Zephyr (Linux Style) or FreeRTOS (its style). The reality is that K0 adheres to traditional RTOS coding style, with a touch of (early) BSD influence. FreeRTOS and Zephyr that did different.</p>
</div>
<div class="paragraph data-line-56">
<p>Much of the so-called "software engineering" best practice were never intended for systems programming. K0&#8217;s code deliberately repeat patterns rather than introduce unnecessary coupling that would hinder long-term evolution. The code prioritises observability and debuggability, not opaque structures.</p>
</div>
<div class="admonitionblock warning data-line-59">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph data-line-60">
<p><strong><em>Embedded Kernel Dysphoria</em></strong>.
The misguided belief that a single (physical) address space running clueless threads can somehow mimic a GPOS—<em>and that doing so is desirable</em> for embedded system software.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<h1 id="core_mechanisms" class="sect0 data-line-68"><strong><em>Core Mechanisms</em></strong></h1>
<div class="paragraph data-line-70">
<p>This section provides a high-level description of the kernel core mechanisms: scheduler, timers, and memory allocator.</p>
</div>
<div class="sect1 data-line-73">
<h2 id="data_structures">1. Data Structures</h2>
<div class="sectionbody">
<div class="sect2 data-line-75">
<h3 id="task_control_block">1.1. Task Control Block</h3>
<div class="paragraph data-line-76">
<p>Threads are represented as Tasks. Every task is associated to a Task Control Block structure. This is a record for stack, resources and time management. The table below represent a Task Control Block with all optional features enabled.</p>
</div>
<table class="tableblock frame-all grid-all stretch data-line-79">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Task Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Task name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Saved Stack Pointer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stack Address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stack Size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Status (ready, running, sending…​)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Assigned Priority</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current Priority</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time-Slice</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remaining time-slice</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Last wake-time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary Semaphore Status</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Flags</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Self-Assigned ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Task Handle Address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run-To-Completion Flag</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time-out Flag</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yield Flag</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aggregated list node</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-101">
<p>Tasks are static - they cannot be created on runtime, to be destroyed, to fork or join.</p>
</div>
<div class="paragraph data-line-103">
<p>In practice, tasks are either running or waiting for their turn to run. When there is no blocking condition, we say a task is <code>READY</code>—it is just waiting for the scheduler. When there is a blocking condition, the task is <code>WAITING</code>. A task needs to be READY to be picked up by the kernel scheduler and switched to <code>RUNNING</code>.</p>
</div>
<div class="imageblock data-line-106">
<div class="content">
<img src="images/images/taskstates.png" alt="taskstates">
</div>
</div>
<div class="paragraph data-line-109">
<p>We extend the WAITING state logically as:</p>
</div>
<div class="ulist data-line-111">
<ul>
<li class="data-line-111">
<p>PENDING : the task suspended itself waiting for a direct signal.</p>
</li>
<li class="data-line-113">
<p>SLEEPING: A task is normally sleeping for an event. We explore this broad concept a bit later.</p>
</li>
<li class="data-line-115">
<p>BLOCKED: A task is blocked in a critical region when trying to access a busy resource.</p>
</li>
<li class="data-line-117">
<p>SENDING/RECEIVING: This is the same as blocked, but the busy resource is a kernel object for the message passing (or similar) mechanism.</p>
</li>
</ul>
</div>
<div class="sect3 data-line-120">
<h4 id="task_queues">1.1.1. Task Queues</h4>
<div class="paragraph data-line-121">
<p>The backbone of the queues where tasks will wait for their turn to run is a circular doubly linked list: removing any item from a doubly list takes O(1) (provided we don’t need to search the item). As the kernel knows each task’s address, adding and removing is always O(1). Singly linked lists, can’t achieve O(1) for removal in any case.</p>
</div>
<div class="paragraph data-line-123">
<p>Another design choice towards achieving O(1) is the global ready queue, which is a table of FIFO queues—each queue dedicated to a priority—and not a single ordered queue. So, enqueuing a ready task is always O(1). Given the sorting needed, if tasks were placed on a single ready queue, the time complexity would be O(n).</p>
</div>
</div>
</div>
<div class="sect2 data-line-125">
<h3 id="the_scheduling_algorithm">1.2. The scheduling algorithm</h3>
<div class="paragraph data-line-127">
<p>It goes like this: as the ready queue table is indexed by priority - the index 0 points to the queue of ready tasks with priority 0, and so forth, and there are 32 possible priorities - a 32-bit integer can represent the state of the ready queue table. It is a BITMAP:</p>
</div>
<div class="listingblock data-line-129">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">The BITMAP computation: ((1a) OR (1b)) AND (2), s.t.:

(1a) Every Time a task is readied, update: BITMAP |= (1U &lt;&lt; task-&gt;priority );
(1b) Every Time an empty READY QUEUE becomes non-empty, update: BITMAP |= (1U &lt;&lt; queueIndex)
(2): Every Time READY QUEUE becomes empty, update: BITMAP &amp;= ~(1U &lt;&lt; queueIndex);
EXAMPLE:

  Ready Queue Index :     (6)5 4 3 2 1 0
          Not empty :      1 1 1 0 0 1 0
                           -------------&gt;
                 (LOW)  Effective Priority  (HIGH)
In this case, the scenario is a system with 7 priority task levels. Queues with priorities 6, 5, 4, and 1 are not empty.</code></pre>
</div>
</div>
<div class="paragraph data-line-147">
<p>The idle task priority is assigned by the kernel, during initialisation, taking into account all priorities the system programmer has defined. Unless user tasks are occupying all 32 priorities, the Idle Task is treated as an ordinary lowest priority and has a position in the queue. If not, the idle task on practice will have no queue position and will be selected when the BITMAP is 0. In the above bitmap, the idle task is in readyQueue[6].</p>
</div>
<div class="paragraph data-line-149">
<p>Given this mask, we know that we shall start inspecting on the LSBit and stop when the first 1 is found. There are uncountable manners of doing this. The approach I chose is:</p>
</div>
<div class="paragraph data-line-151">
<p>(1) Isolate the rightmost '1':</p>
</div>
<div class="listingblock data-line-153">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">RBITMAP = BITMAP &amp; -BITMAP. (- is the bitwise operator for two's complement: ~BITMAP + 1) `</code></pre>
</div>
</div>
<div class="paragraph data-line-157">
<p>In this case:</p>
</div>
<div class="listingblock data-line-159">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">                           [31]       [0]  :  Bit Position
                             0...1110010   :  BITMAP
                             1...0001110   : -BITMAP
                            =============
                             0...0000010   :  RBITMAP
                                     [1]</code></pre>
</div>
</div>
<div class="paragraph data-line-169">
<p><em>The rationale here is that, for a number N, its 2’s complement -N, flips all bits - except the rightmost '1' (by adding '1') . Then, N &amp; -N results in a word with all 0-bits except for the less significant '1'.</em></p>
</div>
<div class="paragraph data-line-171">
<p>(2) Extract the rightmost '1' position:</p>
</div>
<div class="paragraph data-line-173">
<p>Within GCC, the <em>_builtin_ctz()</em> function does the trick: it returns the number of <em>trailing</em> 0 bits within an integer, starting from the LSbit. The number of 'trailing zeroes' equals the position where the first '1' is found, which is also the ready queue index (and hence the priority) of the next task to be dispatched.</p>
</div>
<div class="paragraph data-line-175">
<p>Using ARMv7M instructions, a possible solution is to use the CLZ (count lead zeros):</p>
</div>
<div class="listingblock data-line-177">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">.global __getReadyPrio
.type __getReadyPrio, %function
.thumb_func
__getReadyPrio:
CLZ  R12, R0
MOV  R0, R12
NEG  R0, R0
ADD  R0, #31

BX LR</code></pre>
</div>
</div>
<div class="paragraph data-line-190">
<p>Thus, we subtract 31 from the number of leading zeroes, and get the index.</p>
</div>
<div class="paragraph data-line-192">
<p>The source code in K0BA looks like:</p>
</div>
<div class="listingblock data-line-194">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">static inline PRIO kCalcNextTaskPrio_()
{
    if (readyQBitMask == 0U)
    {
        return (idleTaskPrio);
    }
    readyQRightMask = readyQBitMask &amp; -readyQBitMask;
    PRIO prioVal = (PRIO) (__getReadyPrio(readyQRightMask));
    return (prioVal);
    /* or GCC builtin (more portable): */
    /* return (PRIO)(__builtin_ctz(readyQRightMask)); */
}

VOID kSchSwtch(VOID)
{
	nextTaskPrio = calcNextTaskPrio_();
	K_TCB* nextRunPtr = NULL;
	K_ERR err = kTCBQDeq( &amp;readyQueue[nextTaskPrio], &amp;nextRunPtr);
	if ((nextRunPtr == NULL) || (err != K_SUCCESS))
	{
	    kErrHandler(FAULT_READYQ);
	}
	runPtr = nextRunPtr;
}</code></pre>
</div>
</div>
</div>
<div class="sect2 data-line-222">
<h3 id="scheduler_determinism">1.3. Scheduler Determinism</h3>
<div class="sect3 data-line-223">
<h4 id="preemptive_scheduling">1.3.1. Preemptive Scheduling</h4>
<div class="paragraph data-line-224">
<p>This is a simple test to establish some evidence the scheduler obeys the pre-emption criteria: a higher priority task always pre-empts a lower priority task.</p>
</div>
<div class="paragraph data-line-226">
<p>Task1, 2, 3, 4 are in descending order of priority. If the scheduler is well-behaved, we shall see counters differing by "1".</p>
</div>
<div class="listingblock data-line-228">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C hljs" data-lang="C">VOID Task1(VOID)
{
	while(1)
	{
		counter1++;
		kPend(K_WAIT_FOREVER);
	}
}

VOID Task2(VOID)
{
	while(1)
	{
		counter2++;
		kSignal(task1Handle); /* shall immediately be preempted by task1 */
		kPend(K_WAIT_FOREVER);    /* suspends again */

	}
}


VOID Task3(VOID)
{
	while(1)
	{
		counter3++;
		kSignal(task2Handle);  /* shall immediately be preempted by task2 */
		kPend(K_WAIT_FOREVER); /* suspends again */
	}


}

VOID Task4(VOID)
{
	while(1)
	{
	    counter4++;
	    kSignal(task3Handle); /* shall immediately be preempted by task3 */
                        /* as the lowest priority task it will only be resumed
                           after all higher priority tasks are suspended */
	}

}</code></pre>
</div>
</div>
<div class="paragraph data-line-277">
<p>This is the output after some time running:</p>
</div>
<div class="imageblock data-line-279">
<div class="content">
<img src="images/images/signaldet.png" alt="signaldet">
</div>
</div>
<div class="paragraph data-line-281">
<p>In the above example we have used direct signals. Using semaphores:</p>
</div>
<div class="listingblock data-line-283">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C hljs" data-lang="C">K_SEMA sema1;
K_SEMA sema2;
K_SEMA sema3;
K_SEMA sema4;

VOID kApplicationInit(VOID)
{
	kSemaInit(&amp;sema1, 0);
	kSemaInit(&amp;sema2, 0);
	kSemaInit(&amp;sema3, 0);
	kSemaInit(&amp;sema4, 0);

}

VOID Task1(VOID)
{

	while (1)
	{
		counter1++;
		kSemaWait(&amp;sema1, K_WAIT_FOREVER);
	}
}

VOID Task2(VOID)
{

	while (1)
	{
		counter2++;
		kSemaSignal(&amp;sema1);
		kSemaWait(&amp;sema2, K_WAIT_FOREVER);
	}
}

VOID Task3(VOID)
{
	while (1)
	{
		counter3++;
		kSemaSignal(&amp;sema2);
		kSemaWait(&amp;sema3, K_WAIT_FOREVER);
	}
}

VOID Task4(VOID)
{
	while (1)
	{

		counter4++;
		kSemaSignal(&amp;sema3);
	}
}</code></pre>
</div>
</div>
<div class="imageblock data-line-341">
<div class="content">
<img src="images/images/determsema.png" alt="determsema">
</div>
</div>
<div class="paragraph data-line-343">
<p>Here tick is running @ 1ms (1KHz)</p>
</div>
</div>
<div class="sect3 data-line-345">
<h4 id="cooperative_scheduling">1.3.2. Cooperative Scheduling</h4>
<div class="paragraph data-line-347">
<p>If we set all tasks at the same priority and every tasks yields the processor, they will run on a round-robin fashion, one after another. So, every time we pause chances are we will be "somewhere in the middle" of a round.</p>
</div>
<div class="paragraph data-line-349">
<p>If every task increases a counter before yielding what we expect to see is a set of counters on a fashion {K, K, K, K-1, K-1, K-1}. Importantly a counter will not offset another by more than 1 if the scheduler is deterministic.</p>
</div>
<div class="listingblock data-line-351">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C hljs" data-lang="C">/* All tasks have the same priority */
VOID Task1(VOID)
{

	while (1)
	{
		count1 += 1;
		kYield();
	}
}

VOID Task2(VOID)
{
	while (1)
	{
		count2 += 1;
		kYield();
	}
}

VOID Task3(VOID)
{
	while (1)
	{
		count3 += 1;
		kYield();
	}

}

VOID Task4(VOID)
{
	while (1)
	{
		count4 += 1;
		kYield();
	}

}

VOID Task5(VOID)
{
	while (1)
	{
		count5 += 1;
		kYield();
	}

}</code></pre>
</div>
</div>
<div class="paragraph data-line-403">
<p>The picture below show the results after ~ 13 million rounds.</p>
</div>
<div class="imageblock data-line-406">
<div class="content">
<img src="images/images/determrr.png" alt="determrr">
</div>
</div>
</div>
</div>
<div class="sect2 data-line-408">
<h3 id="common_scheduling_pitfalls">1.4. Common scheduling pitfalls</h3>
<div class="paragraph data-line-410">
<p>To avoid the most common pitfalls when scheduling tasks the system programmer should be aware that:</p>
</div>
<div class="ulist data-line-412">
<ul>
<li class="data-line-412">
<p>The scheduler behaviour is to choose the highest priority READY task to run. Always.</p>
</li>
<li class="data-line-414">
<p>A task must switch to <em>READY</em> state before being eligible for scheduling. If no time slice is enabled, the only way a task will switch from <em>RUNNING</em> to <em>READY</em> is by yielding. Otherwise it can only go from <em>RUNNING</em> to <em>WAITING</em> (equivalent to) and, eventually, to <em>READY</em>.</p>
</li>
<li class="data-line-416">
<p>So with no time-slice and no blocking conditions you must <em>yield()</em> or <em>sleep</em>(ticks) at the end of a task loop.</p>
</li>
<li class="data-line-418">
<p>Even if all tasks have the same priority, for round-robin a switching trigger might happen - yield, time-slice due, waiting.</p>
</li>
<li class="data-line-420">
<p>A time slice is not a burst. A higher priority task when ready will pause a lower priority task in the middle of its time slice. So a time-slice can be split on several <em>RUNNING</em> states.</p>
</li>
<li class="data-line-422">
<p>Make sure the number of tasks and the highest (lowest effective) assigned priority is correct in <code>kconfig.h</code>. If wrong, the scheduler might not run one or more tasks or hard fault when switching.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-424">
<h2 id="timers">2. <strong>Timers</strong></h2>
<div class="sectionbody">
<div class="paragraph data-line-426">
<p>Every kernel object is identified by a handle the system programmer assigns. Any kernel object that may change its behaviour because of a condition in time can contain a <code>TIMEOUT NODE</code>, enabling it to be an element of an ordered list of objects prone to a time event.</p>
</div>
<div class="paragraph data-line-428">
<p>This list is a doubly linked-list, ordered as a delta-list. For instance, three timers (T1,8), (T2,6) and (T3,10) will be ordered as a sequence &lt;(T2,6), (T1,2), (T3,2)&gt; - so it counts &lt;6, (6)+2, ((6)+2)+2&gt;.</p>
</div>
<div class="paragraph data-line-430">
<p>Thus for every system tick only the head element on the list needs to be decreased - yielding O(1)  - another design choice towards deterministic behaviour.</p>
</div>
<div class="sect2 data-line-432">
<h3 id="sleep_timers">2.1. Sleep Timers</h3>
<div class="paragraph data-line-434">
<p>The primitive <code>sleep(t)</code> suspends a task on a SLEEPING state, for <code>t</code> ticks starting to count when called.</p>
</div>
<div class="paragraph data-line-436">
<p>For periodic activations, use <code>sleepuntil(p)</code> in which p is an absolute suspension period of time in ticks. The kernel adjusts any time drift/jitters that might happen in-between calls. If time-slice scheduler is enabled, this primitive is not available.</p>
</div>
</div>
<div class="sect2 data-line-438">
<h3 id="blocking_time_out">2.2. Blocking Time-out</h3>
<div class="paragraph data-line-440">
<p>These are timers associated to kernel calls that are blocking and thus might benefit from establishing an upper bound waiting time - when time for unblocking is out, the kernel call returns indicating a timeout error.</p>
</div>
</div>
<div class="sect2 data-line-442">
<h3 id="callout_timers">2.3. Callout Timers</h3>
<div class="paragraph data-line-444">
<p>These are Application Timers that will issue a callback when expiring.
Besides a callout function, an Application Timer receives an initial phase delay, a period, and has the option to happen once (one-shot) or to auto-reload itself.</p>
</div>
<div class="paragraph data-line-447">
<p>The callback runs within a System Task that has priority 0 and is run-to-completion - what makes the scheduler prioritise it over other tasks. Callouts must be made short and unblocking - as they can cause high CPU contention.</p>
</div>
<div class="paragraph data-line-449">
<p>For clarity, Callout Timers are on a separated list in the kernel - although they share the same <code>TIMEOUT</code> node.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-451">
<h2 id="system_tick">3. <strong>System Tick</strong></h2>
<div class="sectionbody">
<div class="paragraph data-line-453">
<p>The kernel time reference is provided by dedicated peripheral that generates an interrupt on a defined period. For ARMv7M this peripheral is the built-in <em>SysTick</em>, a 24-bit counter timer.
On every tick the handler performs some housekeeping and assess the need to call a context switch.</p>
</div>
<div class="paragraph data-line-456">
<p>The "housekeeping" accounts for global timer tracking and for any tick-dependent condition that might change a task status.
When a timer expires, it might switch a task from <code>WAITING</code> to <code>READY</code> or dispatch a callback. In the case of a callback, this will also trigger a context-switching for the TimerHandler System Task in which the callback is executed and the related timer(s) updated properly.</p>
</div>
<div class="paragraph data-line-459">
<p>Note that tasks might switch from <code>WAITING</code> to <code>READY</code> for reasons other than tick-related. In these cases, context switching might be triggered immediately if the readied task is allowed to preempt the running task.</p>
</div>
</div>
</div>
<div class="sect1 data-line-461">
<h2 id="memory_allocator">4. <strong>Memory Allocator</strong></h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch data-line-464">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Memory Allocator Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Associated Block Pool</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of Blocks</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Block Size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of Free Blocks</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Free Block List</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-473">
<p>Bear in mind that the standard <code>malloc()</code>  leads to fragmentation and (also, because of that) is highly indeterministic. Unless we are using it once - to allocate memory before starting up, it doesn’t fit. But often, we need to 'multiplex' memory amongst tasks over time, that is, to dynamically allocate and deallocate.</p>
</div>
<div class="paragraph data-line-475">
<p>To avoid fragmentation we use fixed-size memory blocks. A simple approach would be a static table marking each block either as free or taken. With this pattern, you will need to 'search' for the next available block, if any - the time for searching changes - what is indeterministic.</p>
</div>
<div class="paragraph data-line-477">
<p>A suitable approach is to keep track of what is free using a linked list of addresses - a dynamic table. We use "meta-data" to initialise the linked-list - every address holds the "next" address value.</p>
</div>
<div class="paragraph data-line-479">
<p>This approach limits that the minimal size of a block is the size of a memory address - 32-bit for our supported architecture. Yet, this is the cheapest way to store meta-data. If not storing on the empty address itself, an extra 32-bit variable would be needed to each block, so it could have a size that is less than 32-bit.</p>
</div>
<div class="paragraph data-line-481">
<p>When a routine calls <code>alloc()</code> the address to be returned is the one free list is pointing to, say addr1. Before, we update free list to point to the value stored within addr1, say addr8.</p>
</div>
<div class="paragraph data-line-483">
<p>When a routine calls <code>free(addr1)</code>, we overwrite whatever has been written in addr1 with the value free list points to (if no more <code>alloc()</code> were issued, it still is addr8), and addr1 is the free list head again.</p>
</div>
<div class="paragraph data-line-485">
<p>A major hazard is having a routine writing to non-allocated memory within a pool, as it will spoil the meta-data.</p>
</div>
<div class="sect2 data-line-487">
<h3 id="memory_allocator_determinism">4.1. Memory Allocator Determinism</h3>
<div class="paragraph data-line-489">
<p>The memory allocator (if well employed) will never fail; it might take the same amount of time to allocate and free a block. In the test below, three tasks with the same priority are allocating, increasing a counter, and freeing a single block of 128 bytes. If the allocator exhibits deterministic behaviour, these counters might differ by at most 1 whenever we pause the device.</p>
</div>
<div class="listingblock data-line-491">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C hljs" data-lang="C">#include "application.h"

INT stack1[STACKSIZE];
INT stack2[STACKSIZE];
INT stack3[STACKSIZE];

K_MEM bufPool;
#define BLOCK_SIZE	128
#define	N_BLOCKS	3
BYTE buf[N_BLOCKS][BLOCK_SIZE];


VOID kApplicationInit(VOID)
{
	kMemInit(&amp;bufPool, buf, BLOCK_SIZE, N_BLOCKS);
}

volatile int counter1, counter2, counter3=0;

VOID Task1(VOID)
{
	while (1)
	{
		BYTE* addr = kMemAlloc(&amp;bufPool);
		kassert(addr!=NULL);
		K_ERR err = kMemFree(&amp;bufPool, addr);
		kassert(err==0);
		counter1++;
		kYield();
	}
}

VOID Task2(VOID)
{
	while (1)
	{

		BYTE* addr = kMemAlloc(&amp;bufPool);
		kassert(addr!=NULL);
		K_ERR err = kMemFree(&amp;bufPool, addr);
		kassert(err==0);
		counter2++;
		kYield();
	}
}

VOID Task3(VOID)
{
	while (1)
	{

		BYTE* addr = kMemAlloc(&amp;bufPool);
		kassert(addr!=NULL);
		K_ERR err = kMemFree(&amp;bufPool, addr);
		kassert(err==0);
		counter3++;
		kYield();
	}

}</code></pre>
</div>
</div>
<div class="paragraph data-line-555">
<p>Below the results after ~2.5 million ticks of 1 ms.</p>
</div>
<div class="imageblock data-line-557">
<div class="content">
<img src="images/images/determmem.png" alt="determmem" width="75%">
</div>
</div>
<hr>
<div class="admonitionblock warning data-line-562">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph data-line-563">
<p><strong><em>Zero-cost wishful thinking</em></strong>. The idea that bad abstractions are better than no abstractions.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<h1 id="inter_task_communication_itc" class="sect0 data-line-566"><strong><em>Inter-task communication (ITC)</em></strong></h1>
<div class="paragraph data-line-568">
<p>In this section, a high-level description of the mechanisms used for communication between tasks is presented.</p>
</div>
<div class="paragraph data-line-570">
<p><strong><em>Tasks coordination (synchronisation)</em></strong></p>
</div>
<div class="paragraph data-line-572">
<p>K0 provides <em>Semaphores</em> (Counter and Binary), Condition Variables (the <em>Event</em> primitive) and
<em>Event Flags</em> (for multi-condition synchronisation).</p>
</div>
<div class="paragraph data-line-575">
<p><em>Mutexes</em> with priority inheritance are for locking critical regions.</p>
</div>
<div class="paragraph data-line-577">
<p><strong><em>Message Passing</em></strong></p>
</div>
<div class="paragraph data-line-579">
<p>In real-time applications, Message Passing often encounters the following scenarios:</p>
</div>
<div class="olist arabic data-line-581">
<ol class="arabic">
<li class="data-line-581">
<p>Some messages are consumed by tasks that can&#8217;t do anything before processing a information - thus, these messages end up also being signals. <em>E.g.: a server that needs a command to process, or a client that blocks for an answer</em>.
Two tasks with different rates need to communicate data—a faster producer might use a buffer to accommodate a relative small burst of generated data, or a faster consumer will drop replicated received data.</p>
</li>
<li class="data-line-583">
<p>Other times, we might need correlate data with time for processing, so, using a queue gives us the idea of data motion. <em>Eg., when calculating the mean value of a transductor on a given period</em>.</p>
</li>
<li class="data-line-584">
<p>On the other hand, for some tasks past data is useless - they need the most recent data for processing - <em>e.g., a drive-by-wire mechanism is interested in the most recent data during its operation</em>.</p>
</li>
</ol>
</div>
<div class="paragraph data-line-586">
<p>All these cases are covered by K0 with the mechanisms of Mailboxes, Message Streams and Cyclical Asynchronous Buffers.</p>
</div>
<div class="paragraph data-line-588">
<p>These mechanisms are highly modular and do not depend on synchronisation primitives.</p>
</div>
<div class="sect1 data-line-590">
<h2 id="synchronisation_mechanisms">1. <strong>Synchronisation mechanisms</strong></h2>
<div class="sectionbody">
<div class="sect2 data-line-592">
<h3 id="events_sleepwake">1.1. Events (Sleep/Wake)</h3>
<table class="tableblock frame-all grid-all stretch data-line-595">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Event Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sleeping Queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout Node</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-601">
<p>An event is a condition in time that will trigger a reaction: a countdown timer reaching zero, or the 7th bit of the 7th received stream on the 7th pin in the 7th full moon night in the 7th year of system uptime - is 0. These are 2 events. The reactions we don’t bother - can even be 'to ignore the event'.</p>
</div>
<div class="paragraph data-line-603">
<p>Events are pure signals - <em>they are either absent or present, and we don’t have the notion of time for an event.</em> An "outsider" has no idea of what a signal means.</p>
</div>
<div class="paragraph data-line-605">
<p>The general nomenclature for methods that check for an event might be <code>sleep()</code>, <code>wait()</code>, or <code>pend()</code>. Methods that notify the existence of an event are commonly labeled with <code>signal()</code>, <code>post()</code>, or <code>wake()</code>. The actual behaviour depends on the system and the mechanism.</p>
</div>
<div class="paragraph data-line-607">
<p>An Event in K0 is a kernel object that encapsulates a queue of tasks waiting for a condition (event) to be true. Purposely, there is nothing within the Event object to record whether this condition is true or false (has happened or not). It is a queue, initially empty.</p>
</div>
<div class="paragraph data-line-609">
<p>The primitives are <code>sleep()</code>, <code>signal()</code> and <code>wake()</code>. A <code>sleep()</code> always results in a task suspending in a <code>SLEEPING</code> state. In <code>K0</code> tasks <code>sleep()</code> for an event that <em>is going to happen</em>.</p>
</div>
<div class="paragraph data-line-611">
<p>Another task/ISR might be responsible for notifying those waiting for the event. <code>wake()</code> affects all tasks that are sleeping for an event: they all switch to <code>READY</code> at once. On the other hand, a <code>signal()</code> will dequeue a single task. Queue discipline is by priority.</p>
</div>
</div>
<div class="sect2 data-line-613">
<h3 id="semaphores">1.2. Semaphores</h3>
<div class="sect3 data-line-615">
<h4 id="counter_semaphore">1.2.1. Counter Semaphore</h4>
<table class="tableblock frame-all grid-all stretch data-line-617">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Semaphore Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter (Signed Integer)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Waiting Queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-623">
<p>A <em>counter</em> semaphore is an event counter. It means the primitives <code>signal()</code> and <code>wait()</code> will increase and decrease, respectively, the signed value 'N' of a given semaphore (a semaphore cannot be initialised with a negative value).</p>
</div>
<div class="paragraph data-line-625">
<p>When <code>wait()</code> returns a negative value, the caller is blocked within the semaphore queue. The negative value of a counter semaphore immediately informs us how many tasks are blocked waiting for a signal.</p>
</div>
<div class="paragraph data-line-627">
<p>After becoming negative, every signal issued to a semaphore releases a task until its counter reaches 0—meaning there are no enqueued tasks and no events.</p>
</div>
<div class="paragraph data-line-629">
<p>In K0BA, tasks block and resume within a semaphore-guarded region, either the Priority or FIFO discipline (configured in <code>kconfig.h</code>).</p>
</div>
<div class="paragraph data-line-631">
<p>A binary semaphore that assumes the values 1 or 0 is a special case of counter semaphores. K0 does not have a dedicated structure for <em>public</em> binary semaphores.</p>
</div>
</div>
<div class="sect3 data-line-634">
<h4 id="private_binary_semaphores">1.2.2. Private Binary Semaphores</h4>
<table class="tableblock frame-all grid-all stretch data-line-636">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Within Task Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signalled (Boolean)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Task Handle Pointer (for Timeout Node)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-641">
<p>Each Task has a binary semaphore built in. Since it is a private semaphore, only the task can issue a <code>pend()</code> on its own binary semaphore, but any other task can issue a <code>signal()</code> on it.</p>
</div>
<div class="paragraph data-line-643">
<p>A binary semaphore will record one event at most. So a binary semaphore whose value is <code>0</code> will block when <code>pend()</code>. A signal on a binary semaphore in which the task is <code>PENDING</code> switches the task to <code>READY</code>, but the value will remain <code>0</code>. A signal on a binary semaphore that is <code>1</code> will not increase its value.</p>
</div>
<div class="paragraph data-line-645">
<p>Private binary semaphores are useful for bilateral synchronisation with other tasks or simply for task notification.</p>
</div>
<div class="paragraph data-line-647">
<p>Unlike public Counter Semaphores, private Binary Semaphores do not have a dedicated queue. Only the owner can block on them, and unlike other synchronisation mechanisms, they cannot be disabled.</p>
</div>
</div>
<div class="sect3 data-line-649">
<h4 id="mutex_semaphore">1.2.3. Mutex Semaphore</h4>
<table class="tableblock frame-all grid-all stretch data-line-651">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Mutex Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Locked State (Boolean)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Owner</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Waiting Queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout Node</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-659">
<p>Some code regions are critical in the sense that they cannot be accessed by more than one task at once. Having to acquire a mutex before entering a region—and to release it when leaving—makes that region mutually exclusive.
A mutex is a lock with a notion of ownership: only the task that owns a mutex can unlock it.</p>
</div>
<div class="paragraph data-line-662">
<p>If a task without an owner tries to lock it, it switches to a <code>BLOCKED</code> state until the mutex is unlocked—as on semaphores. But, different from semaphores, the complementary operation—<code>unlock()</code>—when issued by a non-owner has undefined behaviour. In K0, it will be hard fault.</p>
</div>
<div class="paragraph data-line-664">
<p>Mutexes are solely for mutual exclusion; they cannot be used for signalling. Although it is somewhat common (mainly in textbooks) to see Counter Semaphores initialised as 1 to create mutual exclusion, it can work fine if all tasks accessing the region have the same priority.</p>
</div>
<div class="paragraph data-line-666">
<p>Otherwise, Priority Inversion can become a problem, as will be explained. Besides if the counter semaphore happens to be signalled twice, the mutual exclusive behaviour vanishes.</p>
</div>
<div class="paragraph data-line-668">
<p>In the absence of a Mutex Semaphore, a Binary Semaphore fits better, but in K0, they cannot be used for mutual exclusion since they are private and will not accept a <code>pend()</code> from other tasks.</p>
</div>
<div class="admonitionblock note data-line-671">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph data-line-672">
<p>In normal usage and terminology, a mutex is not referred to as a semaphore. If someone says, “This object is a semaphore,” it implies the non-ownership model and other typical semaphore properties—not the mutual-exclusion contract of a mutex.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4 data-line-675">
<h5 id="priority_inversion">Priority Inversion</h5>
<div class="paragraph data-line-677">
<p>Let TH, TM, and TL be 3 tasks with priority high (H), medium (M) and low (L), respectively. Say TH is dispatched, just to be blocked on a semaphore 'TL' has acquired. Say 'TM' is dispatched and it does not need the resource 'TL' holds. It will pre-empt 'TL'.</p>
</div>
<div class="paragraph data-line-679">
<p>That is to say 'TH' has an <em>unbounded waiting time</em> because any task with priority higher than 'L' that do not need the resource is indirectly preventing it to be unblocked.</p>
</div>
<div class="paragraph data-line-681">
<p>Mutexes in K0 can (optionally) implement a protocol called priority inheritance - 'TL' will have its priority raised to the same as 'H', while holding the resource, so 'TM' cannot pre-empt it anymore. Thus, consider using mutexes for resource sharing whenever possible.</p>
</div>
<div class="admonitionblock tip data-line-684">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph data-line-685">
<p>If sharing resources with semaphores, carefully prioritising the tasks; establishing a time-out for <code>wait()</code>, or - less desirable - using <code>changeprio()</code> before acquiring and <code>restoreprio()</code> after releasing are options to diminish priority inversion.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2 data-line-688">
<h3 id="event_flags">1.3. Event Flags</h3>
<div class="paragraph data-line-690">
<p>Event Flags use a 32-bit unsigned value to represent multiple events in a bitwise manner. Each bit corresponds to one event, allowing for multi-condition notification within the system.</p>
</div>
<div class="paragraph data-line-692">
<p><em>K0</em> provides two Event Flags mechanisms. (It would be odd the need to use both, though.)</p>
</div>
<div class="sect3 data-line-694">
<h4 id="task_flags">1.3.1. Task Flags:</h4>
<table class="tableblock frame-all grid-all stretch data-line-696">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Within Task Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current Flags (32-bit)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Task Handle Pointer (for Timeout Node)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-701">
<p>A task can be configured to maintain a private Event Flags record that only that task can “pend” (wait) on, while multiple tasks can “post” (signal) it. Conceptually, this is similar to having 32 independent binary semaphores—one per bit/event—packaged together for that single task’s use.</p>
</div>
</div>
<div class="sect3 data-line-703">
<h4 id="public_event_flags">1.3.2. Public Event Flags:</h4>
<table class="tableblock frame-all grid-all stretch data-line-705">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Event Control Block (Extended)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current Flags (32-bit)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Waiting Queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout Node</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-711">
<p>When this feature is enabled, the <code>EVENT</code> primitive is expanded to include a 32-bit field (a ULONG on ARMv7M). While this is not “inheritance” in the object-oriented sense, it is a form of extension.</p>
</div>
<div class="paragraph data-line-713">
<p>This is done to reuse both waiting queue and timeout node of the Event structures.</p>
</div>
<div class="paragraph data-line-715">
<p>Once extended, multiple tasks can both pend and post on the same public Event Flags object.</p>
</div>
<div class="paragraph data-line-717">
<p>For Event Flags, we use: <em>Set</em> instead of Post; <em>Get</em> instead of Pend. These terms more naturally convey the notion of updating or retrieving bitwise information.</p>
</div>
<div class="paragraph data-line-719">
<p>Regardless of whether Event Flags are public or private, they share the same functional behaviour:</p>
</div>
<div class="ulist data-line-721">
<ul>
<li class="data-line-721">
<p><em>Set (Bitwise OR/AND)</em></p>
</li>
</ul>
</div>
<div class="paragraph data-line-723">
<p>A task can set one or more bits in the Event Flags bit string.
Both bitwise OR/AND are operations allowed to be performed over the current bit string.</p>
</div>
<div class="ulist data-line-726">
<ul>
<li class="data-line-726">
<p><em>Get (Checking Bit Patterns)</em></p>
</li>
</ul>
</div>
<div class="paragraph data-line-728">
<p>A task performs a Get on the bit string by specifying:</p>
</div>
<div class="olist arabic data-line-730">
<ol class="arabic">
<li class="data-line-730">
<p>A bit mask representing the event(s) it’s waiting for.</p>
</li>
<li class="data-line-731">
<p>An option (ALL or ANY) that defines how the requested bits must be set to satisfy the condition. ALL means every bit in the mask must be set. ANY means at least one bit in the mask must be set.</p>
</li>
<li class="data-line-733">
<p>Optional Clear: Alongside ALL or ANY, a CLEAR modifier can be applied. If the condition is met (i.e., the request succeeds), the bits that satisfied the condition are cleared from the bit string. This prevents them from “sticking” after the waiting task consumes them.
By combining these options (ALL, ANY, and CnLEAR), tasks can finely control how bits are set, checked, and reset within Evnt Flags.</p>
</li>
</ol>
</div>
<div class="paragraph data-line-736">
<p>If the condition is not yet satisfied after a <em>Get</em> operation, a task will suspend (it is enqueued on the Event waiting queue) with an optional timeout until a <em>Set</em> satisfies the required bit combination. The suspended state label is <code>PENDING_FLAGS</code>.</p>
</div>
<div class="ulist data-line-738">
<ul>
<li class="data-line-738">
<p>For Private Event Flags, a <code>get()</code>  can only be performed by the task that owns the bit string.</p>
</li>
<li class="data-line-740">
<p>After a <code>set()</code> assigns a bit string combination on a public Event Flags object, any <em>PENDING_FLAGS</em> task, if it has its waiting condition satisfied, switches to <em>READY</em>.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning data-line-743">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph data-line-744">
<p>Before enabling and using global Event Flags, carefully consider using private task flags, or message queues, monitor-like approaches.
Event flags are more difficult to reason on their run-time behaviour - they lead to very subtle concurrent issues.
The more fine-grained control you want, the better it is to compose a solution with simple primitives.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-749">
<h2 id="message_passing">2. <strong>Message Passing</strong></h2>
<div class="sectionbody">
<div class="sect2 data-line-751">
<h3 id="mailbox_exchange">2.1. Mailbox (Exchange)</h3>
<div class="paragraph data-line-753">
<p>While in GPOS jargon, mailboxes are queues of messages - as a distinction from pipes (that are stream buffers) - in embedded system software, often mailboxes are said to have a capacity of a single item, and more recently, you will not find it as a distinct mechanism - you use a 1-item queue. Another term for single-item mailboxes is <em>Exchange</em>.</p>
</div>
<table class="tableblock frame-all grid-all stretch data-line-756">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Mailbox Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mail Address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Waiting queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout Node</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-763">
<p>A mail within a mailbox is the address of an object. Both sender and receiver must agree on its concrete implementation.</p>
</div>
<div class="paragraph data-line-765">
<p>A <em>Mailbox</em> will be <code>EMPTY</code> when its storage points to <code>NULL</code>; otherwise, it is <code>FULL</code>. You can initialise a Mailbox as <code>FULL</code> by assigning an initial non-null pointer.</p>
</div>
<div class="paragraph data-line-767">
<p>Mails can be "pure messages" in the sense that they convey data to be processed—e.g., the value of a sensor—or "notifications"—they convey signals, e.g., which sensors have been updated.</p>
</div>
<div class="paragraph data-line-769">
<p>For notifications, the receiver task starts pending on a mailbox. From that, Mailboxes are well-suited to behave as binary semaphores, passing a message as a "token."</p>
</div>
<div class="paragraph data-line-771">
<p>The mail concrete type is application-defined, and the sender and receiver must agree on its implementation. When a producer <code>post()</code> to a <code>FULL</code> mailbox, it (optionally) blocks and is enqueued in the Mailbox waiting queue. The associated task will switch to the state <code>SENDING</code>.</p>
</div>
<div class="paragraph data-line-773">
<p>Likewise, a consumer (optionally) blocks when issuing a <code>pend()</code> on an empty Mailbox. The task status switches to <code>RECEIVING,</code> and it is enqueued in the mailbox waiting queue.</p>
</div>
<div class="paragraph data-line-775">
<p>The waiting queue for a Mailbox has a discipline that can either be priority or FIFO. Default is by priority, to be coherent with the scheduler.</p>
</div>
<div class="paragraph data-line-777">
<p>Besides <code>post()</code> and <code>pend()</code>, other primitives that enable different functionality are <code>peek()</code> to read without removing, <code>postovw()</code> to write on a full mailbox and <code>postpend()</code> - enables to post a message and wait for an answer on an indicated storage, making it straight for synchronous ("zero-buffer") command-response.</p>
</div>
<div class="paragraph data-line-779">
<p><em>Some use mailboxes to store messages that are read but never extracted - only replaced. In this strict use-case a global data and a mutex (to avoid race conditions) is a better solution.</em></p>
</div>
</div>
<div class="sect2 data-line-781">
<h3 id="message_queues">2.2. Message Queues</h3>
<div class="paragraph data-line-783">
<p>The classic Message Queue on UNIX SVR4 is defined as the 'head of a linked list of messages'. Some RTOSes implement Message Queues using linked lists, and in these cases, a central pool of buffers might exist. In K0, it was like this until recently.</p>
</div>
<div class="paragraph data-line-785">
<p>Currently, <em>K0</em> has two types of message queues available: pointer-oriented and byte-oriented. Neither of the two is implemented with lists or has pre-allocated buffers within the kernel. The user must provide the storage for buffering.</p>
</div>
<div class="paragraph data-line-787">
<p>A <em>Stream</em> is a ring buffer of N messages with <em>an arbitrary fixed size.</em> As a byte-oriented mechanism, <em>Streams perform deep copies</em> - from sender storage to queue buffer, and from queue buffer to receiver storage - resembling (named) Unix Pipes.</p>
</div>
<div class="paragraph data-line-789">
<p>We say a Queue is a multi-item Mailbox—it holds multiple 4-byte messages, typically pointers to <code>VOID</code>. Queues are flexible because the user can implement deep copies when needed.</p>
</div>
<div class="sect3 data-line-791">
<h4 id="queue">2.2.1. Queue</h4>
<table class="tableblock frame-all grid-all stretch data-line-794">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Queue Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Buffer Address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write Position</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read Position</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max. number of mails</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current number of mails</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Waiting queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout Node</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip data-line-807">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph data-line-808">
<p>Mailboxes are to Queues as binary semaphores are to counter semaphores. Indeed, some RTOSes implement semaphores using mailboxes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-811">
<p>The programmer needs to provide a buffer able to hold N message addresses for a queue. The main primitives for queues are post (), pend (), peek (), and jam (). Mails will be enqueued in a FIFO order. Blocked tasks on a Queue object are released either by priority or FIFO (configurable).</p>
</div>
<div class="paragraph data-line-813">
<p>A Queue is preferable over a Message Stream for communications when some level of asynchrony is needed and the application can maintain message scope.</p>
</div>
<div class="paragraph data-line-815">
<p>Note that if messages are 4-byte values (INT, UINT, ULONG in ARMv7M architecture), you can simply cast them to <code>ADDR</code>, and they will be copied to the mail queue with no additional overhead. The receiver shall cast it back (snippet below).</p>
</div>
<div class="exampleblock data-line-817">
<div class="content">
<div class="listingblock data-line-818">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C hljs" data-lang="C">VOID SenderTask(VOID)
{

  UINT mesg = 1;

  while(1)
  {
    ADDR sendPtr = (ADDR)mesg;
    mesg = mesg+1; /* no changes in the mesg that will be sent */
    kQueuePost(&amp;mqueue, sendPtr, K_WAIT_FOREVER);
    /* suspend full */
  }

}

VOID RecvrTask(VOID)
{

  UINT rcvd[8] = {0};
  UINT idx=0;
  while(1)
  {
    kQueuePend(&amp;mqueue, (ADDR*)&amp;rcvd[idx], K_WAIT_FOREVER);
    /* suspend empty */
    idx += 1;
    idx %= 8;

  }
  /*after 9 pends, rcvd[] = {1, 2, 3, ..., 8}-wrap-{9, 2, ..., 8} */
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock data-line-854">
<div class="content">
<div class="admonitionblock note data-line-856">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Queues transmit a 4-byte message size. Copies for items larger than 4 bytes might be elsewhere - the queue buffer will hold <em>references</em> to them.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph data-line-859">
<p>Now, consider the following example that can be regarded as a middle-ground - since a deep copy for a data structure is performed once - from sender to memory pool - but not from memory pool to receiver:</p>
</div>
<div class="exampleblock data-line-861">
<div class="content">
<div class="listingblock data-line-862">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C hljs" data-lang="C">struct mesg
{
	UINT key;
	CHAR mesg[12]; /* a shallow copy will not get this */
};

#define N_MESG 8
#define MESG_SIZE sizeof(struct mesg) /* 16 bytes */

BYTE mesgPool[N_MESG][MESG_SIZE]; /* pool of mesg buffers */
struct mesg* buf[8]; /* to store addresses */

K_MEM mem; /* allocator */
K_QUEUE mqueue; /* queue */

/* for testbench */
CHAR *messages[8] =
{ "Message 0", "Message 1", "Message 2", "Message 3", "Message 4", "Message 5",
		"Message 6", "Message 7" };

VOID kApplicationInit(VOID)
{
	/* init allocator */
	kMemInit(&amp;mem, (ADDR) mesgPool, MESG_SIZE, N_MESG);
	/* init mailbox */
	kQueueInit(&amp;mqueue, (ADDR) buf, 8);
}
VOID Task1(VOID)
{
	UINT i = 0;
	struct mesg *sendPtr;
	while (1)
	{
		/* allocate buffer */
		sendPtr = NULL;
		sendPtr = (struct mesg*) kMemAlloc(&amp;mem);
		if (sendPtr != NULL)
		{
			sendPtr-&gt;key = i;
			ULONG mesgLen = kStrLen(messages[i]);
			ULONG r = kMemCpy(sendPtr-&gt;mesg, messages[i], mesgLen);
			kassert(r &gt; 0);
			kprintf("Sending: %s \n\r", sendPtr-&gt;mesg);
			kQueuePost(&amp;mqueue, sendPtr, K_WAIT_FOREVER);
			i += 1;
			i %= 8;
		}
		else
		{
			kYield(); /* no more mesg buffers, yield */
		}
	}
}

VOID Task2(VOID)
{
	struct mesg *recvPtr = NULL;
	while (1)
	{
		kQueuePend(&amp;mqueue, (ADDR*) &amp;recvPtr, K_WAIT_FOREVER); /* will block when empty */
		kprintf("Received: %s \n\r", recvPtr-&gt;mesg);
		kBusyDelay(2); /* pretend working */
		kMemFree(&amp;mem, (ADDR) recvPtr); /* free memory */
	}
}</code></pre>
</div>
</div>
<div class="imageblock data-line-931">
<div class="content">
<img src="images/images/mboxqueue.png" alt="mboxqueue">
</div>
</div>
</div>
</div>
<div class="paragraph data-line-934">
<p>Note that the receiver does not copy the message to its address. The scope of the message is managed by allocating a different buffer for every <code>post()</code>.The buffer is deallocated by the receiver after consuming the message. When the producer runs out of buffers, it yields.</p>
</div>
</div>
<div class="sect3 data-line-938">
<h4 id="stream">2.2.2. Stream</h4>
<table class="tableblock frame-all grid-all stretch data-line-940">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Message Stream Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write Index</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read Index</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Block Size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max of messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Count</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout Node</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-951">
<p>For each Stream, the user provides a buffer address with enough capacity (number of messages <em>x</em> message size) to be handled as a ring buffer.</p>
</div>
<div class="paragraph data-line-953">
<p>Streams resemble classic (named) Pipes. The difference is that messages have a fixed size because they have a format (application-defined). Pipes, on the other hand, transmit and receive any number of bytes for each operation.</p>
</div>
<div class="paragraph data-line-955">
<p>The message size associated with a Message Stream instance is defined on its initialisation. On transmission, a <em>deep copy</em>  of a message from the sender&#8217;s storage to the queue takes place; on reception, it moves from the queue to the receiver&#8217;s storage.</p>
</div>
<div class="paragraph data-line-957">
<p>The important primitives for Message Streams are <code>send()</code>, <code>recv()</code>, <code>jam()</code> and <code>peek()</code>.</p>
</div>
<div class="paragraph data-line-959">
<p>Sending to a full queue (optionally) blocks the sender. Likewise, receiving from an empty queue. The waiting queue has a discipline that can either be priority or FIFO. Default is by priority, to be coherent with the scheduler.</p>
</div>
<div class="paragraph data-line-961">
<p>In the same way that you can send 4-byte values by copying them to <em>Queues</em>, you can send pointers using <em>Streams</em> as 4-byte messages.</p>
</div>
</div>
</div>
<div class="sect2 data-line-963">
<h3 id="pump_drop_buffers">2.3. Pump-Drop Buffers</h3>
<table class="tableblock frame-all grid-all stretch data-line-966">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pump-Drop Message Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocator</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Most Recent Buffer Address</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch data-line-973">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pump-Drop Buffer</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data Address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data Size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Readers Count</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-980">
<p>Between a message that does not arrive and one that arrives with information that is not useful, there is no practical difference. But if a message arrives with information that will deceive your control loop to perform a wrong action - this is the worst. This is why <em>Pump-Drop Buffers</em> are a feature in K0BA.</p>
</div>
<div class="paragraph data-line-982">
<p>Pump-drop buffering resembles double buffering: buffers switch back and forth as write-only and read-only. It is an asynchronous method meant to be used when message queues do not fit: when the reader needs the most recent data and is up to afford losing some data (the producer is faster) or reading the same (the producer is slower). It is a <em>one-to-many</em> channel associated to an allocator. (Essentially, it is the mechanism proposed on the HARTIK kernel.)</p>
</div>
<div class="paragraph data-line-984">
<p>Primitives for Pump-Drop Messages are:</p>
</div>
<div class="ulist data-line-986">
<ul>
<li class="data-line-986">
<p>For writer: <code>reserve()</code> and <code>pump()</code>.</p>
</li>
<li class="data-line-988">
<p>For readers: <code>fetch()</code>  and <code>drop()</code>.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-990">
<p>The semantics is as follows - remember it is one writer to many readers:</p>
</div>
<div class="paragraph data-line-992">
<p>When the producer needs to write a new message, it first reserves a PD buffer. This buffer might already be allocated, but if it is allocated but has readers, a new PD buffer is allocated to ensure data consistency.</p>
</div>
<div class="olist arabic data-line-994">
<ol class="arabic">
<li class="data-line-994">
<p>Writer now appends a message to be sent (application-dependent) and pump the buffer.</p>
</li>
<li class="data-line-996">
<p>After pumped, the PD buffer is marked as the current buffer. From now on, the former pumped PDB cannot be fetched and will eventually drop to 0 readers.</p>
</li>
</ol>
</div>
<div class="paragraph data-line-998">
<p>A reader first 'fetches' a PDB. A non-null return for a fetch increases the number of readers on the PDB.</p>
</div>
<div class="paragraph data-line-1000">
<p>After 'having' the message, a reader 'drops the PD-buffer': the kernel checks if it was the last reader and if it is not the current PDB. If these two conditions are met, the buffer is deallocated. (Checking it is NOT the current PDB guarantees there is already a new PDB in the circuit, so readers won’t starve.)</p>
</div>
<div class="admonitionblock tip data-line-1003">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph data-line-1004">
<p>This mechanism guarantees that the information is always updated, but no message is corrupted. Thus, the ideal pool size is simply the number of tasks + 1.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-1007">
<p>Note the message passed is an address. The receiver can copy the message to local a buffer since a PD buffer is never deallocated while in use and nev
er fetched if there is a new buffer.</p>
</div>
<hr>
</div>
</div>
</div>
<h1 id="usage_patterns" class="sect0 data-line-1014"><strong>Usage Patterns</strong></h1>
<div class="paragraph data-line-1016">
<p>This section includes some simple usage patterns. The board used to run these snippets is a Nucleo-F103RB (ARM Cortex-M3-based).</p>
</div>
<div class="paragraph data-line-1018">
<p>You can find RTOS concepts and design patterns at <a href="http://www.kernel0.org/blog">www.kernel0.org/blog</a></p>
</div>
<div class="sect1 data-line-1020">
<h2 id="extended_rendezvous_1">1. <em>Extended rendezvous #1</em></h2>
<div class="sectionbody">
<div class="paragraph data-line-1021">
<p>Usage: Many-to-one command-response.</p>
</div>
<div class="listingblock data-line-1023">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">#include "application.h"


#define MAX_PAYLOAD 36

K_MBOX serverMbox;
K_MBOX clientMbox1;
K_MBOX clientMbox2;

/* Application Protocol Data Unit */
typedef struct
{
	BYTE length; /* Length of the APDU payload */
	BYTE payload[MAX_PAYLOAD]; /* APDU payload */
	K_MBOX *replyMbox; /* Pointer to the client's reply mailbox */
} APDU;


void kApplicationInit(VOID)
{
	kMboxInit(&amp;serverMbox, NULL);
	kMboxInit(&amp;clientMbox1,NULL);
	kMboxInit(&amp;clientMbox2,NULL);
}

/* Hello-server */
VOID Server(VOID)
{
	APDU *request, response;

	while (1)
	{
		/* Wait for a request */
		if (kMboxPend(&amp;serverMbox, &amp;request, NULL, K_WAIT_FOREVER) == K_SUCCESS)
		{
			kprintf("Server received request: %s\n\r", request-&gt;payload);

			/* Process the request */
			response.length = snprintf((char*) response.payload,
					sizeof(response.payload), "Response to: %s",
					request-&gt;payload);

			/* Send the response back to the client's reply mailbox */
			if (kMboxPost(request-&gt;replyMbox, &amp;response, K_WAIT_FOREVER) != K_SUCCESS)
			{
				kprintf("ACK fail\n\r");
			}
		}
	}
}

/* Hello-clients */
/
VOID Client1(VOID)
{
	APDU request, *response;

	while (1)
	{
		/* Prepare the request */
		snprintf((char*) request.payload, sizeof(request.payload),
				"Hello from Client 1");
		request.length = strlen((char*) request.payload);
		request.replyMbox = &amp;clientMbox1; /* Specify the reply mailbox */

		/* Send the request to the server */
		if (kMboxPost(&amp;serverMbox, &amp;request, K_WAIT_FOREVER) == K_SUCCESS)
		{

			/* Wait for the response */
			if (kMboxPend(&amp;clientMbox1, (ADDR*)&amp;response, K_WAIT_FOREVER)
					== K_SUCCESS)
			{
				kprintf("C1 ACK'ed %s\n\r", response-&gt;payload);
			}
			else
			{
				kprintf("1F\n\r");
			}
		}
		else
		{
			kprintf("1F\n\r");
		}
	}
	kSleepUntil(10); /* every 50ms */
}

VOID Client2(VOID)
{
	APDU request, *response;

	while (1)
	{
		/* Prepare the request */
		snprintf((char*) request.payload, sizeof(request.payload),
				"Hello from Client 2");
		request.length = strlen((char*) request.payload);
		request.replyMbox = &amp;clientMbox2; /* Specify the reply mailbox */

		/* Send the request to the server */
		if (kMboxPost(&amp;serverMbox, &amp;request, K_WAIT_FOREVER) == K_SUCCESS)
		{

			/* Wait for the response */
			if (kMboxPend(&amp;clientMbox2, (ADDR*)&amp;response, K_WAIT_FOREVER)
					== K_SUCCESS)
			{
				kprintf("C2 ACK'ed: %s\n\r", response-&gt;payload);
			}
			else
			{
				kprintf("2FAIL\n\r");
			}
		}
		else
		{
			kprintf("2FAIL\n\r");
		}

	}
	kSleep(10); /* 50ms */
}</code></pre>
</div>
</div>
<div class="imageblock data-line-1149">
<div class="content">
<img src="images/images/multiclient.png" alt="multiclient">
</div>
</div>
</div>
</div>
<div class="sect1 data-line-1151">
<h2 id="extended_rendezvous_2">2. <em>Extended rendezvous</em> #2</h2>
<div class="sectionbody">
<div class="paragraph data-line-1152">
<p>This snippet uses the mailbox <code>kMboxPostPend()</code> method.
Usage: client-server communication.</p>
</div>
<div class="listingblock data-line-1155">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">#include "application.h"

/* the most expensive basic calculator ever made */

typedef enum
{
	ADD, SUB, MULT

} OP_ID_t;

struct request
{
	OP_ID_t opcode;
	INT parm1;
	INT parm2;

};

typedef struct request REQ_t;

K_MBOX mbox;

VOID kApplicationInit(VOID)
{

	kMboxInit(&amp;mbox, NULL);
}

VOID Task1(VOID)
{

	REQ_t req;
	INT *resultPtr;
	req.opcode = 0;

	while (1)
	{
		req.parm1 = 1531;
		req.parm2 = 33;
		kprintf("Requesting server ... -&gt;\n\r");

		/* all-in-one: post what is on "req" and pend for results that will be in resultPtr */
		kMboxPostPend(&amp;mbox, &amp;req, (ADDR*)&amp;resultPtr, K_WAIT_FOREVER);
		kprintf("-&gt; The result is %d\n\r", (INT)*resultPtr);
		req.opcode++;
		if (req.opcode &gt; 2)
			req.opcode = ADD;
	}
}

VOID Task2(VOID)
{
	REQ_t *clientReq;
	while (1)
	{
		/* pend for client request */
		kMboxPend(&amp;mbox, (ADDR*)&amp;clientReq, K_WAIT_FOREVER);
		INT parm1 = clientReq-&gt;parm1;
		INT parm2 = clientReq-&gt;parm2;
		INT result = 0;
		kprintf("Recv client request &lt;-\n\r");
		switch (clientReq-&gt;opcode)
		{
		case (ADD):
			kprintf("Adding...\n\r");
			result = parm1 + parm2;
			break;
		case (SUB):
			kprintf("Subtracting...\n\r");
			result = parm1 - parm2;
			break;
		case (MULT):
			kprintf("Multiplying...\n\r");

			result = parm1 * parm2;
			break;
		default:
			kprintf("Unknown...\n\r");

			break;

		}
		kprintf("&lt;- Sending response..\n\r");
		/* send answer */
		kMboxPost(&amp;mbox, &amp;result, K_WAIT_FOREVER);

	}
}</code></pre>
</div>
</div>
<div class="imageblock data-line-1247">
<div class="content">
<img src="images/images/sendrecv.png" alt="sendrecv">
</div>
</div>
</div>
</div>
<div class="sect1 data-line-1249">
<h2 id="monitor_0_barrier">3. <em>Monitor</em> #0 (Barrier)</h2>
<div class="sectionbody">
<div class="paragraph data-line-1251">
<p>Usage: resource access/tasks coordination.</p>
</div>
<div class="listingblock data-line-1253">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">#include "application.h"

K_EVENT syncEvent; /* state event				    */
UINT syncCounter; /* state representation        */
K_MUTEX syncMutex; /* monitor lock				    */
K_MUTEX resourceLock; /* if there is a resource */
#define SYNC_CONDITION (syncCounter&gt;=3) /* needed tasks in the barrier */


VOID kApplicationInit(VOID)
{
	kMutexInit(&amp;syncMutex);
	kEventInit(&amp;syncEvent);
	kMutexInit(&amp;resourceLock);
	syncCounter = 0;
}


/* only one task can be active within a monitor
 they are enqueued either on the mutex or on the event
 */
static VOID synch(VOID)
{

	kMutexLock(&amp;syncMutex, K_WAIT_FOREVER);
	kprintf("Task %d  entered monitor...\n\r", K_RUNNING_TID);
	syncCounter += 1;
	if (!(SYNC_CONDITION))
	{
	    /* must be atomic */
	    kDisableIRQ();
		kMutexUnlock(&amp;syncMutex);
		kEventSleep(&amp;syncEvent, K_WAIT_FOREVER);
		kEnableIRQ();
		/* not rechecking the condition, as it will be 0
		   right after the third task gets in */
  	    kMutexLock(&amp;syncMutex, K_WAIT_FOREVER);
  	    /* locked in */
		kprintf("Task %d is active in the monitor...\n\r", K_RUNNING_TID);
	}
	else
	{
		syncCounter = 0; /* reset */
		kprintf("Task %d frees the waiting queue. \n\r", K_RUNNING_TID);
		kEventWake(&amp;syncEvent); /* the first to wake will
		lock on the mutex */
	}
	kMutexUnlock(&amp;syncMutex); /* turnstile... */
	kprintf("Task %d leaves monitor...\n\r", K_RUNNING_TID);
}

VOID Task1(VOID)
{

	while (1)
	{
		kSleep(5);
		synch();
	}
}

VOID Task2(VOID)
{
	while (1)
	{
		kSleep(8);
		synch();
	}
}

VOID Task3(VOID)
{
	while (1)
	{
		kSleep(3);
		synch();
	}

}</code></pre>
</div>
</div>
<div class="imageblock data-line-1337">
<div class="content">
<img src="images/images/syncbarr.png" alt="syncbarr">
</div>
</div>
</div>
</div>
<div class="sect1 data-line-1340">
<h2 id="monitor_1_turnstile">4. <em>Monitor</em> #1 (Turnstile)</h2>
<div class="sectionbody">
<div class="paragraph data-line-1342">
<p>In this variation we use mailboxes for turnstile. Also the task that wakes up all others will use the resource within the monitor (be active).</p>
</div>
<div class="listingblock data-line-1344">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">K_EVENT syncEvent; /* state event				    */
UINT syncCounter; /* state representation        */
K_MBOX syncMbox;

#define SYNC_CONDITION (syncCounter&gt;=3) /* needed tasks in the barrier */

VOID kApplicationInit(VOID)
{
	kEventInit(&amp;syncEvent);
	kMboxInit(&amp;resourceMbox, &amp;mayAcquire);
	kMboxInit(&amp;syncMbox, &amp;mayEnter);

	syncCounter = 0;
}

static VOID synch(VOID)
{
    /* keys */
    UINT mayEnter = 0xAABBCCDD;
    UINT *enterPtr;

	kMboxPend(&amp;syncMbox, (ADDR*) &amp;enterPtr, K_WAIT_FOREVER); /*got the key*/
	syncCounter += 1;
	if (!(SYNC_CONDITION))
	{
	    kDisableIRQ();
	    /* put the key back */
		kMboxPost(&amp;syncMbox, &amp;mayEnter, K_WAIT_FOREVER);
		kEventSleep(&amp;syncEvent, K_WAIT_FOREVER);
		kEnableIRQ();
		/* ouch, who got the keys? */
    	kMboxPend(&amp;syncMbox, (ADDR*) &amp;enterPtr, K_WAIT_FOREVER);
	}
	syncCounter = 0;
	kprintf("Task %d wakes all...\n\r", K_RUNNING_TID);
	kEventWake(&amp;syncEvent); /* free all tasks */
	kprintf("Task %d is active in the monitor...\n\r", K_RUNNING_TID);
	/* leave turnstile...*/
	kMboxPost(&amp;syncMbox, &amp;mayEnter, K_WAIT_FOREVER);
}

VOID Task1(VOID)
{

	while (1)
	{
		kSleep(5);
		synch();
	}
}

VOID Task2(VOID)
{
	while (1)
	{
		kSleep(8);
		synch();
	}
}

VOID Task3(VOID)
{
	while (1)
	{
		kSleep(3);
		synch();
	}

}</code></pre>
</div>
</div>
<div class="paragraph data-line-1417">
<p><span class="image"><img src="images/images/mboxturnstiles.png" alt="mboxturnstiles"></span></p>
</div>
</div>
</div>
<div class="sect1 data-line-1419">
<h2 id="multi_condition_notification_0">5. <em>Multi-condition Notification</em> #0</h2>
<div class="sectionbody">
<div class="paragraph data-line-1421">
<p>Usage: coordinate a notified task action on a combination of events.</p>
</div>
<div class="listingblock data-line-1423">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">/* @file application.c */

#include "application.h"

/* waiting 4 flags to be active before going */

INT stack1[STACKSIZE];
INT stack2[STACKSIZE];
INT stack3[STACKSIZE];

typedef enum
{
	TEMPERATURE = 1, HUMIDITY, CO2, FLOW
} UPDATE_t;

#define FLAG_TEMP_SENSOR_UPDATE   (1U &lt;&lt; 0)
#define FLAG_HUM_SENSOR_UPDATE    (1U &lt;&lt; 1)
#define FLAG_CO2_SENSOR_UPDATE    (1U &lt;&lt; 2)
#define FLAG_FLOW_SENSOR_UPDATE   (1U &lt;&lt; 3)

K_MBOX mbox;

/*** Init kernel objects here */
VOID kApplicationInit(VOID)
{
	kMboxInit(&amp;mbox, NULL);
}

/* this task notifies which sensors had been updated */
VOID NotifyTask(VOID)
{
	UINT sendFlag = 0;
	UPDATE_t updateType = 0;

	while (1)
	{   /* simple sum to switch sensor type */

			updateType = (updateType + 1);
			if (updateType &gt; 4)
			{
				updateType = 1;
			}
			switch (updateType)
			{
			case (TEMPERATURE):
				sendFlag = FLAG_TEMP_SENSOR_UPDATE;
				break;
			case (HUMIDITY):
				sendFlag = FLAG_HUM_SENSOR_UPDATE;
				break;
			case (CO2):
				sendFlag = FLAG_CO2_SENSOR_UPDATE;
				break;
			case (FLOW):
				sendFlag = FLAG_FLOW_SENSOR_UPDATE;
				break;
			default:
				break;
			}
			K_ERR err = kMboxPost(&amp;mbox, (ADDR) &amp;sendFlag, K_WAIT_FOREVER);
			kSleepUntil(2); /* every 10ms */
		}
}

/* this task stores events by OR'ing. when it matches the expected event record it expects to take an action, the storage is reset.
alternatively it could take an action whenever a single flag was active */

VOID NotifiedTask(VOID)
{
	UINT *rcvdFlag = 0;
	UINT wantedFlags = FLAG_TEMP_SENSOR_UPDATE | FLAG_HUM_SENSOR_UPDATE |
	FLAG_CO2_SENSOR_UPDATE |
	FLAG_FLOW_SENSOR_UPDATE;
	UINT rcvdFlags = 0;
	while (1)
	{
		K_ERR err = kMboxPend(&amp;mbox, (ADDR*) &amp;rcvdFlag, K_WAIT_FOREVER);
		if (err == 0)
		{
			rcvdFlags |= *rcvdFlag;
			if (rcvdFlags == wantedFlags)
			{
				rcvdFlags = 0; /* clear rcvd flags */
				kprintf("Task synchronized\n\r");
					/* do work */
			}
			else
			{
				kprintf("Still missing a flag\n\r");
			}
		}
	}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-1520">
<p><span class="image"><img src="images/images/mboxflags.png" alt="mboxflags"></span></p>
</div>
<hr>
<div class="paragraph data-line-1524">
<p>&#169; <em>2025 Antonio Giacomelli | All Rights Reserved | www.kernel0.org</em></p>
</div>
</div>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>
