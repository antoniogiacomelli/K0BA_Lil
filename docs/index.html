<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>K0BA: Real-Time Kernel '0'</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
</head>
<body class="book toc2 toc-left data-line-1">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#k0ba_real_time_kernel_0">K<strong><em>0</em></strong>BA: <em>Real-Time Kernel '0'</em></a>
<ul class="sectlevel1">
<li><a href="#operating_systems_and_the_kernel_abstraction">1. Operating systems and the 'Kernel' abstraction</a>
<ul class="sectlevel2">
<li><a href="#the_grounds">1.1. The grounds</a></li>
</ul>
</li>
<li><a href="#threads">2. Threads</a></li>
<li><a href="#k0ba_o1_scheduler">3. K0BA O(1) Scheduler</a>
<ul class="sectlevel2">
<li><a href="#data_structures">3.1. Data Structures</a></li>
<li><a href="#the_scheduling_algorithm">3.2. The scheduling algorithm</a></li>
</ul>
</li>
<li><a href="#timers">4. Timers</a>
<ul class="sectlevel2">
<li><a href="#task_delays">4.1. Task Delays</a></li>
<li><a href="#application_timers">4.2. Application Timers</a></li>
</ul>
</li>
<li><a href="#memory_allocator">5. Memory Allocator</a></li>
<li><a href="#direct_task_signal">6. Direct Task Signal</a></li>
<li><a href="#counter_semaphores">7. Counter Semaphores</a></li>
<li><a href="#mutex_semaphores">8. Mutex Semaphores</a></li>
<li><a href="#events_sleepwake">9. Events (Sleep/Wake)</a></li>
<li><a href="#remarks_on_synchronisation_services">10. Remarks on synchronisation services</a>
<ul class="sectlevel2">
<li><a href="#apparent_overlap">10.1. Apparent overlap</a></li>
<li><a href="#installed_callbacks_for_signals">10.2. Installed callbacks for signals</a></li>
<li><a href="#time_out_on_blocking_primitives">10.3. Time-out on blocking primitives</a></li>
<li><a href="#event_groups">10.4. Event Groups</a></li>
</ul>
</li>
<li><a href="#mailbox">11. Mailbox</a>
<ul class="sectlevel4">
<li><a href="#send_receive">Send-receive</a></li>
<li><a href="#aynchronous_mailboxes_methods">Aynchronous mailboxes methods</a></li>
</ul>
</li>
<li><a href="#message_queue">12. Message Queue</a></li>
<li><a href="#pump_drop_message_queue">13. "Pump-Drop" Messages</a></li>
<li><a href="#remarks_on_message_passing">14. Remarks on Message Passing</a></li>
<li><a href="#pipes">15. Pipes</a></li>
<li><a href="#usage_patterns">16. Usage Patterns</a>
<ul class="sectlevel2">
<li><a href="#notify_with_a_mailbox">16.1. Notify with a mailbox</a></li>
<li><a href="#multi_client_server_with_mailboxes">16.2. Multi-Client Server with mailboxes</a></li>
<li><a href="#monitor_like_synchronisation_barrier">16.3. Monitor-like: Synchronisation Barrier</a></li>
<li><a href="#queueing_pattern">16.4. Queueing Pattern</a></li>
<li><a href="#event_flagsevent_groups">16.5. Event Flags/Event Groups</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph data-line-1">
<p><a href="http://github.com/antoniogiacomelli/K0BA_Lite">Repository</a> <strong>|</strong> <a href="https://github.com/antoniogiacomelli/K0BA_Lite/blob/VER031/Inc/kapi.h">API</a></p>
</div>
<div class="admonitionblock note data-line-4">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph data-line-5">
<p>This is a high-level design description. API details can be found in <a href="https://github.com/antoniogiacomelli/K0BA_Lite/blob/VER031/Inc/kapi.h">kapi.h</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<h1 id="k0ba_real_time_kernel_0" class="sect0 data-line-9">K<strong><em>0</em></strong>BA: <em>Real-Time Kernel '0'</em></h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph data-line-16">
<p><strong>K0BA</strong> stands for <em>Kernel '0' for Embedded Applications</em>.
It targets real-time constrained devices. The "zero" represents a <em>low-overhead</em> design based on "grounded" system software concepts.</p>
</div>
<div class="paragraph data-line-19">
<p>K0BA Lite assumes no memory isolation is supported at all. The design embraces this limitation rather than working around it.</p>
</div>
<div class="paragraph data-line-21">
<p>Although the supported architecture (ARMv7M) allows privilege levels even when no MPU is provided, the scenario is that code that runs unprivileged cannot issue privileged instructions, yet, unprivileged code can sweep the entire memory.</p>
</div>
<div class="paragraph data-line-23">
<p>In this case, privilege levels would add the overhead of system calls and harm <em>determinism</em>, for a rather limited safety. We do not think it pays off.</p>
</div>
<div class="paragraph data-line-25">
<p><strong><em>"As modular as possible, rarely opaque."</em></strong></p>
</div>
<div class="paragraph data-line-27">
<p>K0BA <em>does not aim to be an application framework</em>.</p>
</div>
<div class="paragraph data-line-29">
<p>The goal is to provide a balanced set of helpful services while never replacing the <em>system&#8217;s programmer</em> ownership.</p>
</div>
<div class="imageblock data-line-31">
<div class="content">
<img src="images/layeredkernel.png" alt="K0BA architecture">
</div>
</div>
<div class="paragraph data-line-32">
<p><em>K0BA architecture - the dashed line within the API reminds the 'application' layer is an illusion</em></p>
</div>
<div class="paragraph data-line-34">
<p>A layered depiction:</p>
</div>
<table class="tableblock frame-all grid-all stretch data-line-37">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>APPLICATION PROGRAMMING INTERFACE</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MESSAGE PASSING</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TASK SYNCHRONISATION</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">APPLICATION TIMERS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MEMORY MANAGEMENT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOW-LEVEL SCHEDULER</p></td>
</tr>
</tbody>
</table>
<hr>
<div class="paragraph data-line-50">
<p>“<em>I conclude that there are two ways of constructing a software design: One way is to make it so simple that there are obviously no deficiencies and the other way is to make it so complicated that there are no obvious deficiencies. The first method is far more difficult (&#8230;&#8203;) it requires a willingness to accept objectives which are limited by physical, logical, and technological constraints, and to accept a compromise when conflicting objectives cannot be met. (Tony Hoare, 1980, Turing Award Lecture)</em>”</p>
</div>
<hr>
</div>
</div>
<div class="sect1 data-line-54">
<h2 id="operating_systems_and_the_kernel_abstraction">1. Operating systems and the 'Kernel' abstraction</h2>
<div class="sectionbody">
<div class="paragraph data-line-56">
<p>The ISO/IEC 2382 standard defines an operating system as “software that controls the execution of programs and that may provide services such as resource allocation, scheduling, input/output control, and data management.”.</p>
</div>
<div class="paragraph data-line-58">
<p>A deprecated German standard, the DIN 44300, defined an operating system as “the programs of a digital computer system that together with the properties of the computing system form the basis for the possible operating modes of the digital computing system, and which in particular control and monitor program execution.” Both definitions are pretty much the same, emphasising control and execution. The latter though, brings up the “properties of the computing system”. This reinforces that an operating system is hardware-dependent software. In turn, hardware is domain-dependent: a PC, a microwave, a fighter jet radar, a smart card…</p>
</div>
<div class="paragraph data-line-60">
<p>Traditional operating system textbooks define an OS as a “resource manager and an extended machine”. As a manager, it orchestrates resource allocation to potentially conflicting application requests; as an extended machine, it makes it easier to design applications by providing a set of abstractions and mechanisms that abstract the hardware.</p>
</div>
<div class="sect2 data-line-63">
<h3 id="the_grounds">1.1. The grounds</h3>
<div class="paragraph data-line-65">
<p>Pir Brinch Hansen coined the kernel concept in 1969 when designing the RC4000 operating system. At the time, he used the terms <em>system monitor</em> or <em>nucleus</em>. He aimed to provide a reusable, extensible mechanism to construct other operating systems around the same software core for the same machine. In his work he describes the role of a kernel (nucleus) in an operating system:</p>
</div>
<div class="paragraph data-line-67">
<p>“<em>The system nucleus coordinates multiprogramming and communication processes - a monitor with complete control of input/output, store protection, and interrupt response. I do not regard the monitor as an independent process but rather as a software extension of the hardware structure that makes the computer more attractive for multiprogramming. Its function is to implement the process concept and the primitives that processes can call to create and control other processes and communicate with them. It is the only program which executes privileged instructions.</em>”</p>
</div>
<div class="imageblock data-line-69">
<div class="content">
<img src="images/kernelsuperuser.png" alt="kernelsuperuser">
</div>
</div>
<div class="paragraph data-line-71">
<p>The description provided by Hansen remains. The traditional definition of an operating system as a resource manager and extended machine overlaps with the definition of a kernel.</p>
</div>
<div class="paragraph data-line-73">
<p>Formally, the “kernel” distinction can be made only if a hardware mechanism enables the separation of privileges for code and data. The takeaway is that when this hardware is absent, the kernel is a purely logical layer, and the operating system is a library-based or kernel-less operating system - and that&#8217;s what K0BA Lite is (and what most RTOSes for constrained devices you see around are).</p>
</div>
<div class="paragraph data-line-75">
<p>With no memory virtualisation, and no affordable swapping, what is left is a single program image and a single resident process. We tweak it to create semi-independent (clueless) running units - threads - there is no isolation between a thread and another.</p>
</div>
<div class="paragraph data-line-77">
<p>Even low-end MCUs might provide an MPU it is not virtualisation, as you see on <em>multiprogramming</em>  kernels. They are memory firewalls that burn the house down when violated.</p>
</div>
<div class="paragraph data-line-79">
<p>Real-time means system software needs to tick at the same pace of the changes in the environment we control.
I understand this alone is enough to avoid indirection levels the most we can - that is, abstract just enough.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-82">
<h2 id="threads">2. Threads</h2>
<div class="sectionbody">
<div class="paragraph data-line-84">
<p>Conceptually, as the majority of constrained embedded system software, K0BA runs a single program split into a number of user-defined running units: the <em>threads</em>.</p>
</div>
<div class="paragraph data-line-86">
<p>Multithreading within a single-process is an arrangement: instead of of having a single super-loop, we have many - each one running on its own execution stack.</p>
</div>
<div class="paragraph data-line-88">
<p>Probably because we don&#8217;t have a better abstraction, we use multithreading to fine-tune our load balance, and therefore the responsiveness to achieve real-time.</p>
</div>
<div class="paragraph data-line-90">
<p>The cost is the complexity to deal with shared memory, resources, and everything that comes with making every task (thread) to believe it owns the entire processor.</p>
</div>
<div class="paragraph data-line-92">
<p>That&#8217;s when creating machinery to tame threads is useful, a real-time kernel.</p>
</div>
</div>
</div>
<div class="sect1 data-line-94">
<h2 id="k0ba_o1_scheduler">3. K0BA O(1) Scheduler</h2>
<div class="sectionbody">
<div class="paragraph data-line-96">
<p>The K0BA scheduler is a priority-based, rate-monotonic scheduler. Tasks with shorter periods shall be assigned higher priorities. A higher priority task always preempts a low priority task. The algorithm is supposed to work up to a load of around 70%.</p>
</div>
<div class="paragraph data-line-98">
<p>The scheduler supports 255 tasks and 32 priorities. Remarkably, it is an O(1) scheduler: no matter the number of tasks to choose from, the scheduler will always spend the same amount of (logical) time.</p>
</div>
<div class="sect2 data-line-101">
<h3 id="data_structures">3.1. Data Structures</h3>
<div class="sect3 data-line-104">
<h4 id="task_control_block">3.1.1. Task Control Block</h4>
<div class="paragraph data-line-106">
<p>Threads are represented as <em>Tasks</em>.
Every task is associated to a <em>Task Control Block</em> structure. This is a record for stack, resources and time management:</p>
</div>
<table class="tableblock frame-all grid-all stretch data-line-110">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Task Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Task name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Saved Stack Pointer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stack Adddress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stack Size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Status (ready, running, sending&#8230;&#8203;)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Assigned Priority</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current Priority</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User Assigned ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kernel Assigned ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time-Slice</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remaining time-slice</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Last wake-time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flags: run-to-completion, timed-out, yielded</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pending resources: semaphores, mutexes, timers, message passing, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Monitoring: dispatch counter, lost signals, number of preemptions, preempted by</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aggregated list node</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-130">
<p>Tasks are static - they cannot be created on runtime, to be destroyed, to fork or join.</p>
</div>
<div class="paragraph data-line-132">
<p>On practice, tasks are either running or waiting for its turn to run.
When there is no blocking condition, we say a task is <em>READY</em> - it is just waiting for the scheduler.
When there is a blocking condition the task is <em>WAITING</em>. A tasks needs to be <em>READY</em> to be picked up by the kernel scheduler and switch to <em>RUNNING</em>.</p>
</div>
<div class="paragraph data-line-136">
<p>We extend the <em>WAITING</em> state logically as:</p>
</div>
<div class="ulist data-line-138">
<ul>
<li class="data-line-138">
<p>PENDING : the task suspended itself waiting for a signal.</p>
</li>
<li class="data-line-139">
<p>SUSPENDED: the task has been suspended by another task, and will be signaled.</p>
</li>
<li class="data-line-140">
<p>SLEEPING: a task sleep for events - a logical state to change.</p>
</li>
<li class="data-line-141">
<p>BLOCKED: a task is blocked on a critical region, when trying to access a busy resource</p>
</li>
<li class="data-line-142">
<p>RECEIVING: same as blocked, but the busy resource was a message-passing object, which task is trying to receive from.</p>
</li>
<li class="data-line-143">
<p>SENDING: same, but trying to send to.</p>
</li>
</ul>
</div>
</div>
<div class="sect3 data-line-147">
<h4 id="task_queues">3.1.2. Task Queues</h4>
<div class="paragraph data-line-148">
<p>The backbone of the queues where tasks will wait for its turn to run is a circular doubly linked list: removing any item from a doubly list takes O(1) (provided we don&#8217;t need to search the item). As the kernel is aware of each task&#8217;s address, adding and removing is always O(1). Singly linked lists, can&#8217;t achieve O(1) for removal in any case.</p>
</div>
<div class="paragraph data-line-150">
<p>One design choice that does not change the time complexity but does improve cyclomatic complexity is having a DUMMY reference, which anchors a list and eases the handling of 'edge cases'.</p>
</div>
<div class="listingblock data-line-153">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">	   HEAD                                           TAIL
	   _____     _____     _____     _____           _____
	  |     |--&gt;|     |--&gt;|     |--&gt;|     |--&gt;   &lt;--|     |
	  |DUMMY|   |  H  |   | H+1 |   | H+2 |  . . .  |  T  |
	&lt;-|_____|&lt;--|_____|&lt;--|_____|&lt;--|_____|         |_____|--&gt;
	|________________________________________________________|


	 - INITIALISE

	 The list is initialised by declaring a node, and assigning its previous
	 and next pointers to itself. This is the anchored reference.
		      _____
		   __|__   |
		  |     |--&gt;
		  |DUMMY|
		&lt;-|_____|
		|____|


	 - INSERT AFTER

		When list is empty we are inserting the head (that is also the tail).
		If not empty:
		 To insert on the head, reference node is the dummy.
		 To insert on the tail, reference node is the current tail
		 (dummy's previous node).
		     _____     _____     _____
		    | ref |-&gt; | new |-&gt; | old |-&gt;
		 . .|     |   |next |   | next| . . .
		  &lt;-|_____| &lt;-|_____| &lt;-|_____|

	 - REMOVE A NODE

	  	 To remove a node we "cut off" its next and previous links, rearranging
	  	 as: node.prev.next = node.next; node.next.prev = node.prev;

		    	         _______________
		         _____  |  _____     ___|_
		        |     |-&gt; |     x   |     |-&gt;
		   . . .|prev |   |node |   | next| . . .
		      &lt;-|_____|   x_____| &lt;-|_____|
			   |______________|


	   To remove the head, we remove the dummy's next node
	   To remove the tail, we remove the dummy's previous node
	   In both cases, the list adjusts itself</code></pre>
</div>
</div>
<div class="admonitionblock note data-line-209">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For list handling, I took an ADT approach prevalent on systems programming and based on aggregation. <em>It is opaque</em>. But, using <code>offsetof()</code>  does not hinder determinism or incurs on runtime overhead - it is a compile-time calculation based on data layout. Generalising the handle of <em>pure data</em> with no penalties on performance while improving maintenance is an abstraction that suits.
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-212">
<p>Thus, comes another design choice towards achieving O(1). The global <em>ready queue</em> is a table of FIFO queues—each queue dedicated to a priority—and not a single ordered queue. So, enqueuing a ready task is always O(1). If tasks were placed on a single ready queue, the time complexity would be O(n), given the sorting needed.</p>
</div>
<div class="listingblock data-line-213">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">         READY QUEUE        |    Index (Priority)
----------------------------------------------
[ ][ ][ ][ ][ ][ ][ ][ ][ ] |      0  (highest effective)
[ ][ ][ ][ ][ ][ ][ ][ ][ ] |      1
              .                    .
              .                    .
              .                    .
[ ][ ][ ][ ][ ][ ][ ][ ][ ] |     N  (s.t. N = lowest effective, user-assigned)
                        [ ] |    N+1 (Reserved: IDLE TASK)</code></pre>
</div>
</div>
<div class="paragraph data-line-228">
<p>So all this boils down to: enqueuing/dequeuing from any task queue on the system, global or associated with a kernel object, is always O(1). Now, it is up to the algorithm that picks the next task to run also to honor O(1).</p>
</div>
</div>
</div>
<div class="sect2 data-line-231">
<h3 id="the_scheduling_algorithm">3.2. The scheduling algorithm</h3>
<div class="paragraph data-line-233">
<p>It goes like this: as the <strong>ready queue</strong> table is indexed by priority - the index 0 points to the queue of ready tasks with priority 0, and so forth, and there are 32 possible priorities - a 32-bit integer can represent the state of the ready queue table. It is a BITMAP:</p>
</div>
<div class="listingblock data-line-235">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">The BITMAP computation: ((1a) OR (1b)) AND (2), s.t.:

(1a) Every Time a task is readied, update: BITMAP |= (1U &lt;&lt; task-&gt;priority );
(1b) Every Time an empty READY QUEUE becomes non-empty, update: BITMAP |= (1U &lt;&lt; queueIndex)
(2): Every Time READY QUEUE becomes empty, update: BITMAP &amp;= ~(1U &lt;&lt; queueIndex);</code></pre>
</div>
</div>
<div class="listingblock data-line-243">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">EXAMPLE:

  Ready Queue Index :     (6)5 4 3 2 1 0
          Not empty :      1 1 1 0 0 1 0
                           -------------&gt;
                 (LOW)  Effective Priority  (HIGH)</code></pre>
</div>
</div>
<div class="paragraph data-line-253">
<p>In this case, the scenario is a system with 7 priority task levels. Queues with priorities 6, 5, 4, and 1 are <em>not empty</em>.</p>
</div>
<div class="paragraph data-line-255">
<p>The idle task priority is assigned by the kernel, during initialisation taking into account all priorities the system programmer has defined.  Unless user-tasks are occupying all 32 piorities, the Idle Task is treated as an ordinary lowest-priority and has a position in the queue. If not, the idle task on practice will have no queue position, and will be selected when the BITMAP is  <code>0</code>.
In the above bitmap, the idletask is in <code>readyQueue[6]</code> .</p>
</div>
<div class="paragraph data-line-258">
<p>Given this mask, we know that we shall start inspecting on the LSBit and stop when the first 1 is found. There are uncountable manners of doing this. The approach I chose is:</p>
</div>
<div class="paragraph data-line-260">
<p>(1) <em>Isolate the rightmost '1':</em></p>
</div>
<div class="listingblock data-line-261">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">RBITMAP = BITMAP &amp; -BITMAP. (- is the bitwise operator for two's complement: ~BITMAP + 1) `</code></pre>
</div>
</div>
<div class="paragraph data-line-264">
<p>In this case:</p>
</div>
<div class="listingblock data-line-266">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">                           [31]       [0]  :  Bit Position
                             0...1110010   :  BITMAP
                             1...0001110   : -BITMAP
                            =============
                             0...0000010   :  RBITMAP
                                     [1]</code></pre>
</div>
</div>
<div class="paragraph data-line-274">
<p><em>The rationale here is that, for a number N, its 2&#8217;s complement -N, flips all bits - except the rightmost '1' (by adding '1') . Then, N &amp; -N results in a word with all 0-bits except for the less significant '1'.</em></p>
</div>
<div class="paragraph data-line-276">
<p>(2) <em>Extract rightmost '1' <strong>position</strong>:</em></p>
</div>
<div class="paragraph data-line-278">
<p>Within GCC, the  <code><em>_builtin_ctz()</code> function does the trick: it returns the number of _trailing</em> 0-bits within an integer, starting from the LSbit. The number of 'trailing zeroes' equals the position where the first '1' is found, that is also the ready queue index (and hence the priority) of the next task to be dispatched.</p>
</div>
<div class="paragraph data-line-280">
<p>Using ARMv7M instructions, a possible solution is to use the CLZ (count lead zeros):</p>
</div>
<div class="listingblock data-line-282">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">.global __getReadyPrio
.type __getReadyPrio, %function
.thumb_func
__getReadyPrio:
CLZ  R12, R0
MOV  R0, R12
NEG  R0, R0
ADD  R0, #31

BX LR</code></pre>
</div>
</div>
<div class="paragraph data-line-295">
<p>Thus, we subtract 31 from the number of leading zeroes, and get the index.</p>
</div>
<div class="paragraph data-line-298">
<p>The source code in K0BA looks like:</p>
</div>
<div class="listingblock data-line-300">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">static inline PRIO kCalcNextTaskPrio_()
{
    if (readyQBitMask == 0U)
    {
        return (idleTaskPrio);
    }
    readyQRightMask = readyQBitMask &amp; -readyQBitMask;
    PRIO prioVal = (PRIO) (__getReadyPrio(readyQRightMask));
    return (prioVal);
    // or GCC builtin (more portable)
    //return (PRIO)(__builtin_ctz(readyQRightMask));
}

VOID kSchSwtch(VOID)
{
	nextTaskPrio = calcNextTaskPrio_();
	K_TCB* nextRunPtr = NULL;
	K_ERR err = kTCBQDeq( &amp;readyQueue[nextTaskPrio], &amp;nextRunPtr);
	if ((nextRunPtr == NULL) || (err != K_SUCCESS))
	{
	    kErrHandler(FAULT_READYQ);
	}
	runPtr = nextRunPtr;
}</code></pre>
</div>
</div>
<div class="sect3 data-line-328">
<h4 id="scheduler_determinism">3.2.1. Scheduler Determinism</h4>
<div class="paragraph data-line-330">
<p>This is a simple test to establish some evidence the scheduler obeys the preemption criteria: a higher priority task always preempts a lower priority task.</p>
</div>
<div class="paragraph data-line-332">
<p>Task1, 2, 3, 4 are in descending order of priority.
If the scheduler is well-behaved, we shall see counters differing by "1".</p>
</div>
<div class="listingblock data-line-335">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">volatile UINT32 counter1;
volatile UINT32 counter2;
volatile UINT32 counter3;
volatile UINT32 counter4;

VOID Task1(VOID)
{
	while(1)
	{
		counter1++;
		kPend();
	}
}

VOID Task2(VOID)
{
	while(1)
	{
		counter2++;
		kSignal(1); /* shall immediately be preempted by task1 */
		kPend();    /* suspends again */

	}
}


VOID Task3(VOID)
{
	while(1)
	{
		counter3++;
		kSignal(2);  /* shall immediately be preempted by task2 */
		kPend();     /* suspends again */
	}


}

VOID Task4(VOID)
{
	while(1)
	{
	    counter4++;
	    kSignal(3); /* shall immediately be preempted by task3 */
                        /* as the lowest priority task it will only be resumed
                           after all higher priority tasks are suspended */
	}

}</code></pre>
</div>
</div>
<div class="paragraph data-line-388">
<p>This is the output after some time running:</p>
</div>
<div class="imageblock data-line-390">
<div class="content">
<img src="images/signaldet.png" alt="signaldet">
</div>
</div>
<hr>
<div class="paragraph data-line-394">
<p>In the above example, we use direct signals. For semaphores:</p>
</div>
<div class="listingblock data-line-396">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">K_SEMA sema1;
K_SEMA sema2;
K_SEMA sema3;
K_SEMA sema4;
volatile UINT32 counter1, counter2, counter3, counter4; /*dont code like this*/
VOID kApplicationInit(VOID)
{
	kSemaInit(&amp;sema1, 0);
	kSemaInit(&amp;sema2, 0);
	kSemaInit(&amp;sema3, 0);
	kSemaInit(&amp;sema4, 0);
	counter1=counter2=counter3=counter4=0; /*dont code like this*/
}

VOID Task1(VOID)
{

	while (1)
	{
		counter1++;
		kSemaWait(&amp;sema1, K_WAIT_FOREVER);
	}
}

VOID Task2(VOID)
{

	while (1)
	{
		counter2++;
		kSemaSignal(&amp;sema1);
		kSemaWait(&amp;sema2, K_WAIT_FOREVER);
	}
}

VOID Task3(VOID)
{
	while (1)
	{
		counter3++;
		kSemaSignal(&amp;sema2);
		kSemaWait(&amp;sema3, K_WAIT_FOREVER);
	}
}

VOID Task4(VOID)
{
	while (1)
	{

		counter4++;
		kSemaSignal(&amp;sema3);
	}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-454">
<p>Here tick is running @ 1ms (1KHz)</p>
</div>
<div class="imageblock data-line-456">
<div class="content">
<img src="images/determsema.png" alt="detsema">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-460">
<h2 id="timers">4. Timers</h2>
<div class="sectionbody">
<div class="sect2 data-line-462">
<h3 id="task_delays">4.1. Task Delays</h3>
<div class="paragraph data-line-464">
<p>The primitive <code>sleep(t)</code> suspends a task on a SLEEPING state, for <code>t</code> ticks. Importantly for periodic tasks is the <code>sleepuntil(p)</code> in which <code>p</code> is an absolute suspension period of time in ticks. The kernel adjusts any time drift/jitters that might happen in-between calls.
<em>(If time-slice scheduler is enabled, this primitive is not available.)</em></p>
</div>
<div class="sect2 data-line-469">
<h3 id="application_timers">4.2. Application Timers</h3>
<table class="tableblock frame-all grid-all stretch data-line-472">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Timer Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mode: Reload/OneShot</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Callout Function</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Callout Arguments</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current Delta Tick</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Next Timer Address</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-482">
<p>K0BA offers two types of application timers - one-shot and auto-reload.
Both have the system tick as the time reference and are countdown timers.</p>
</div>
<div class="paragraph data-line-485">
<p>The system programmer needs to be aware that the callout will run within a deferred handler, that is a run-to-completion system-task.</p>
</div>
<div class="paragraph data-line-487">
<p>One-shot timers that are within a task loop will naturally be activated periodically.
A remark is that timers leverage a <em>delta queue</em>. Suppose you have a set of timers T1, T2, T3. They will countdown from 8, 6 and 10 ticks, respectively. For a regular queue, the node sequence is RQ = &lt;(T1, 8), (T2, 6), (T3, 10)&gt; (at tick=0). The delta queue would have pairs ordered as a sequence (tick=0): DQ = &lt;(T2, 6), (T1, 2), (T3, 2)&gt;. So having to decrease only the list head for any amount of timers, yields O(1) time-complexity within the interrupt handler.</p>
</div>
<div class="ulist data-line-491">
<ul>
<li class="data-line-491">
<p>Application timers <strong>cannot</strong> be disabled.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-494">
<h2 id="memory_allocator">5. Memory Allocator</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch data-line-498">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Memory Allocator Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Associated Block Pool</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of Blocks</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Block Size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of Free Blocks</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Free Block List</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-508">
<p>Bear in mind that the standard <code>malloc</code> leads to fragmentation and (also, because of that) is highly undeterministic. Unless we are using it once - to allocate memory before starting up,  it doesn&#8217;t fit.But often we need to 'multiplex' memory amongst tasks over time, that is to dynamic allocate and deallocate.</p>
</div>
<div class="paragraph data-line-510">
<p>To avoid fragmentation we use fixed-size memory blocks. A simple approach would be a static table marking each block  either as <code>free</code> or <code>taken</code>. With this pattern you will need to 'search' for the next available block, if any - the time for searching changes - what is indeterministic.</p>
</div>
<div class="paragraph data-line-512">
<p>A suitable approach is to keep track of what is free using a linked list of addresses - a dynamic table. We use "meta-data" to initialise the linked-list - every address holds the "next" address value.</p>
</div>
<div class="paragraph data-line-514">
<p>This approach limits that the minimal size of a block is the size of a memory address - 32-bit for our supported architecture. Yet, this is the cheapest way to store meta-data. If not storing on the empty address itself, an extra 32-bit variable would be needed to each block, so it could have a size that is less than 32-bit.</p>
</div>
<div class="paragraph data-line-516">
<p>When a routine calls <code>alloc()</code> the address to be returned is the one free list is pointing to, say <code>addr1</code>. Before, we update free list to point to the value stored within <code>addr1</code>, say <code>addr8</code>.</p>
</div>
<div class="paragraph data-line-518">
<p>When a routine calls <code>free(addr1)</code>, we overwrite whatever has been written in <code>addr1</code> with the value freelist points to (if no more <code>alloc()</code> were issued, it still is <code>addr8</code>), and <code>addr1</code> is the freelist head again.</p>
</div>
<div class="paragraph data-line-520">
<p>A major hazard is having a routine writing to non-allocated memory within a pool, as it will spoil the meta-data.</p>
</div>
<div class="ulist data-line-522">
<ul>
<li class="data-line-522">
<p>The memory allocator <strong>cannot</strong> be disabled.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1 data-line-524">
<h2 id="direct_task_signal">6. Direct Task Signal</h2>
<div class="sectionbody">
<div class="paragraph data-line-526">
<p>Some tasks are entirely reactive and have a single responsibility. It is cheaper and more effective to allow them to pend themselves - and be signalled
without an associated kernel object - such as a semaphore. The <code>signal(id)</code> primitive takes a Task ID as a  parameter. The <code>pend()</code> primitive takes no parameters, acts on the caller task. If a task is signalled when not pending, the error counter "lostSignals" is
increased in its task control block. This counter is meant for some diagnostics. The standard mechanism does not check for lost signals - to catch up with. Doing so would turn it into in dedicated semaphore.
 A <code>PENDING</code> task is placed on a global sleeping queue and removed when signalled—its position in the queue does not matter.</p>
</div>
<div class="paragraph data-line-531">
<p>The main use case is for deferred handlers.
The lack of a control block associated with a direct signal makes it rudimentary but sufficient, justified by the negligible cost and the ubiquity of single-purpose event-driven tasks sitting idle until notified: after readied, the scheduler will take care of its dispatching, respecting the priority. No shared resource, no contention, no priority inversion.</p>
</div>
<div class="paragraph data-line-534">
</div>
<div class="ulist data-line-537">
<ul>
<li class="data-line-537">
<p>Direct signals <strong>cannot</strong> be disabled.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1 data-line-540">
<h2 id="counter_semaphores">7. Counter Semaphores</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch data-line-543">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Semaphore Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signed Counter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Acquirer Task</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Waiting Queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-550">
<p>In K0BA semaphores can be classified as 'strong counter' semaphores. Counter means the primitives <code>signal()</code> and <code>wait()</code> will increase and
 decrease, respectively, the initial signed value 'N' a semaphore is assigned (a semaphore cannot be initialised with a negative value).
 When  <code>wait()</code> results in a negative value, the caller will be blocked within the semaphore queue. The negative value of a counter semaphore inform us straight away how many tasks are blocked waiting for a signal. When signalled only one task is unblocked. If a semaphore has a dedicated queue it is 'strong', because it establishes an order. Not having a queue, make a 'weak' semaphore, as the task to be released depends on the position of the task who signals.
 In K0BA, tasks block and resume within a semaphore-guarded region, ordered by their priority or on a FIFO discipline (that is configured in <code>kconfig.h</code> ).
 Switching to a FIFO discipline might be useful if you notice low-priority tasks starving.</p>
</div>
<div class="paragraph data-line-556">
<p>Semaphores implement a priority propagation protocol to diminish priority inversion.</p>
</div>
<div class="ulist data-line-558">
<ul>
<li class="data-line-558">
<p>Semaphore service can be enabled disabled in <code>kconfig.h</code>.</p>
</li>
</ul>
</div>
<div class="quoteblock data-line-560">
<blockquote>
<div class="paragraph data-line-561">
<p>On the one hand, we have the semaphores used for mutual exclusion, on the other hand, the private semaphores. Critical sections are used always, and only for the purpose of unambiguous inspection and modification of the state variables (allocated in the surrounding universe) that describe the current state of the system (as far as needed for the regulation of the harmonious cooperation between the various processes). (Djikstra, 1968, describing how semaphores were used in the "T.H.E" operating system)</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1 data-line-566">
<h2 id="mutex_semaphores">8. Mutex Semaphores</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch data-line-569">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Mutex Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">State: Locked/Unlocked</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Owner</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Waiting Queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-576">
<p>Mutexes are 'locks'. A locked resource has an owner, and only the owner can release it—a task blocks when trying to lock a locked mutex. Mutexes have a priority propagation protocol. The owner&#8217;s priority is boosted if a higher priority task blocks trying to access (lock) its guarded region.  When a task tries to unlock a mutex it does not own, the behaviour is implementation-dependent. In K0BA, it will hard fault.</p>
</div>
<div class="exampleblock data-line-578">
<div class="content">
<div class="paragraph data-line-579">
<p><em>Mutexes versus Counter Semaphores</em></p>
</div>
<div class="paragraph data-line-581">
<p>If you initialise a counter semaphore to 1, and <strong>guarantee</strong> that this semaphore won&#8217;t be touched by who is not trying to enter/exit its guarded region, the effect of mutual-exclusion is the same as if using a mutex. The mutex is a specialised semaphore, with a notion of ownership preventing accidental unlocking. The thing is that if your system has code poking kernel objects it  shouldn&#8217;t - it has a logical synchronisation problem, and most certainly will fail. Some RTOSes with dynamic task creation can also use the owner identity to forbid a task that owns a mutex to be terminated or to identify its termination: the action if it happens, is implementation-defined. Recursive locking (when provided) is also only possible because a mutex has an owner.</p>
</div>
</div>
</div>
<div class="ulist data-line-585">
<ul>
<li class="data-line-585">
<p>Mutex service can be enabled/disabled.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1 data-line-587">
<h2 id="events_sleepwake">9. Sleep/Wake (Events)</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch data-line-590">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Event Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event ID (self-assigned)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sleeping Queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-596">
<p>An event is a condition in time that will trigger a reaction: a countdown timer reaching zero, or the 7th bit of the 7th received stream on the 7th pin in the 7th fullmoon night in the 7th year of system uptime - being 0. These are 2 events. The reactions we don&#8217;t bother, it can even be 'to ignore the event'.</p>
</div>
<div class="paragraph data-line-598">
<p>Within K0BA, an event is associated to a kernel object. The kernel assigns only an ID and a sleeping queue within an' event' object. Here, an event is a 'pure signal'—it <em>is</em> present or absent. A semaphore is a <em>record</em> of pure signals  (and actually, that was the critical insight that led to the semaphore idea).</p>
</div>
<div class="paragraph data-line-600">
<p>Say a modern car has its speed increased by the driver. Different groups of mechanisms need to be notified to take some action. The radio so that it might boost the volume. The windshield wiper control will increase its speed. The cruiser will switch off - as it might indicate a need for the driver to regain control, and I&#8217;d bet the cruiser switches off before the radio volume is boosted.</p>
</div>
<div class="paragraph data-line-602">
<p>So, tasks <code>sleep(event)</code> forn an event. They rely on another task/ISR to trigger a <code>wake(event)</code> that will <code>READY</code>  <em>all tasks</em> sleeping on that event at once. What happens later, is up to the scheduler and the application design.</p>
</div>
<div class="paragraph data-line-604">
<p>As a single event might be of interest to several devices a semaphore is not suitable - a semaphore signal does not broadcast - it wakes one task for each signal - if any. A common approach when using events is to follow the </code>sleep(event)<code> by a mutex semaphore, so all tasks waking up on that point will mutual-exclusively access a region.</code></p>
</div>
<div class="paragraph data-line-606">
<p>As on <code>VER0.3.1</code> the current design decision is not providing <code>signal()/wait()</code> for events, that is, the ability to enqueue/dequeue single task sleeping for an event. Condition variables and monitor-like synchronisation schemes can be constructed with events associated to mutex semaphores.</p>
</div>
<div class="ulist data-line-608">
<ul>
<li class="data-line-608">
<p>Sleep/Wake service can be enabled/disabled in <code>kconfig.h</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1 data-line-610">
<h2 id="remarks_on_synchronisation_services">10. Remarks on synchronisation services</h2>
<div class="sectionbody">
<div class="sect2 data-line-612">
<h3 id="apparent_overlap">10.1. Apparent overlap</h3>
<div class="paragraph data-line-614">
<p>So, we have direct signals, semaphores, mutex and sleep-wake. And actually, they overlap in the sense they all handle events, but <em>how</em> they handle is enough to justify each of them as a different service:</p>
</div>
<div class="ulist data-line-616">
<ul>
<li class="data-line-616">
<p>The direct signals saved us the overhead of a semaphore structure and operations for a prevalent task pattern within embedded system software: the pend-does-one-thing-pend, such as interrupt service routines split in half-bottom and half-top.</p>
</li>
<li class="data-line-617">
<p>The semaphore accumulates 'ups' and 'downs' of a signal - an increment/decrement + a test within an atomic operation. In enforces them a precedence on acquiring whatever the semaphore is guarding. If the semaphore counter is initialised as '1', effectively, it allows a single running unit to be within the region it is guarding.</p>
</li>
<li class="data-line-618">
<p>The mutex provides the ownership property for a '1'-semaphore, making it easier to track errors.</p>
</li>
<li class="data-line-619">
<p>The sleep-wake provides a broadcast signal for events we don&#8217;t bother to track its history.</p>
</li>
</ul>
</div>
</div>
<div class="sect2 data-line-622">
<h3 id="installed_callbacks_for_signals">10.2. Installed callbacks for signals</h3>
<div class="paragraph data-line-624">
<p>It is tempting to become UNIX-minded and install callbacks on signals. When resuming, a task first checks for any pending signals. If they exist, the task deviates from its normal flow (as within any software interrupt), runs the callback, and deals with any side effects.
The overhead is excessive—both in time and space—a need to reserve a space on the stack or provide a stack for the callback; a need to tune the context-switching to happen when there is a signal pending and to get back to the deviated point.</p>
</div>
</div>
<div class="sect2 data-line-627">
<h3 id="time_out_on_blocking_primitives">10.3. Time-out on blocking primitives</h3>
<div class="paragraph data-line-629">
<p>Blocking primitives within K0BA have a <code>timeout</code> parameter, given in ticks. Only <code>kPend()</code> does not given its logical simplistic nature, and application.
If the task cannot perform  access to a resource within a time given in system ticks, it will switch back to READY, eventually be dispatched, and force a return <code>K_ERR_TIMEOUT</code>.</p>
</div>
</div>
<div class="sect2 data-line-632">
<h3 id="event_groups">10.4. Event Groups</h3>
<div class="paragraph data-line-633">
<p>As on <code>VER0.3.1</code> the decision was not to provide event groups as another abstraction. The reason is that the usage is so versatile and application-dependent that any generalisation leads to a service that will not do better than the system programmer aware of its needs. That is a guideline used to provide a service or not. As we recognise it is a standard service, we are still looking for the enough approach. At the end of this document some usage patterns demonstrate multi-condition notification/synchornisation.</p>
</div>
<div class="admonitionblock note data-line-637">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph data-line-638">
<p>As on <code>VER0.3.1</code> a <code>K_WAIT_FOREVER</code> for time-out is defined as <code>0U</code>, in the sense you can&#8217;t make non-blocking calls within blocking calls. Non-blocking (or asynchronous) calls  have different method names.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-643">
<h2 id="mailbox">11. Mailbox</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch data-line-647">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Mailbox Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mailbox status</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Waiting queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Owner task</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-656">
<p>While in GPOS jargon mailboxes are queues of messages - as a distinction from pipes (that are stream buffers) - in embedded system software, often mailboxes are said to have a capacity of a a single messsage, and more recently you will not find it as a distinct mechanism - you use a 1-message queue.</p>
</div>
<div class="paragraph data-line-658">
<p>In K0BA a mailbox is a <em>message-as-signal</em> mechanism. Strictly it is not a message passing - it is a shared memory protocol. The mail passed is the <em>address</em> of an object that contains a message - there is no copy. This object is application-dependent, so sender and receiver must agree on the concrete type and mantain the message scope.</p>
</div>
<div class="paragraph data-line-660">
<p>Mailboxes can initialise full/empty, have their own waiting queue and handle priority propagation - when passing a token/message between tasks, they synchronise on a <em>turnstile</em> - what is a handy use for them.</p>
</div>
<div class="paragraph data-line-664">
<p>A mailbox interface contract can be defined as follows:</p>
</div>
<div class="olist arabic data-line-666">
<ol class="arabic">
<li class="data-line-666">
<p>A mailbox starts either EMPTY or FULL.</p>
</li>
<li class="data-line-667">
<p>If starting FULL, it is initialised with an address.</p>
</li>
<li class="data-line-668">
<p>A mailbox will always have an assigned 'owner' after the first <code>send()</code> or <code>recv()</code> primitive. The owner is the task who succeded gaining access to the box.</p>
</li>
<li class="data-line-669">
<p>When a producer <code>send()</code> to a FULL mailbox, it is enqueued on the mailbox waiting queue, and its task will now be on state <code>SENDING</code>.</p>
</li>
<li class="data-line-670">
<p>Likewise, a consumer blocks when issuing a <code>recv()</code> on an empty mailbox. Task status switches to <code>RECEIVING</code> and it is enqueued on the mailbox waiting queue.</p>
</li>
<li class="data-line-671">
<p>A mailbox implements a priority propagation protocol, boosting the owner priority on the occasion a higher priority task blocks waiting.</p>
</li>
<li class="data-line-672">
<p>The waiting queue for a mailbox, has a discipline that can either be  priority or FIFO. Default is by priority, to be coherent with the scheduler.</p>
</li>
</ol>
</div>
<div class="paragraph data-line-674">
<p>You need to be aware of how the priority of tasks and mailbox queue discipline impact the message exchange, and therefore the program flow. Say you have a bad idea: two producers and a consumer with priorities High, Medium and Low, respectively. Producers <code>send()</code> and consumer <code>recv()</code> - no other blocking conditions. If the queue discipline for the mailbox is ordered by priority, the medium priority producer will block once and <strong>deadlock</strong> - since when the consumer empties the box, who is released is the higher priority - always. If it is a FIFO, it will receive the two messages serially - if you configure as FIFO, mind <em>you are choosing to delay a higher priority task.</em></p>
</div>
<div class="sect4 data-line-677">
<h5 id="send_receive">Send-receive</h5>
<div class="paragraph data-line-679">
<p>The optional <code>sendrecv()</code> primitive sends a message and waits for a reply - its straight for any synchronous client-server communication - a client sends a request and wait for answer.</p>
</div>
</div>
<div class="sect4 data-line-681">
<h5 id="aynchronous_mailboxes_methods">Aynchronous mailboxes methods</h5>
<div class="paragraph data-line-683">
<p>As an extension for the same synchronous mailboxes there are primitives <code>asend()</code> and <code>arecv()</code>. Instead of blocking they will return an error.</p>
</div>
<div class="paragraph data-line-685">
<p>There two other asynchronous methods: <code>asendovw()</code> - to deposit a message on a mailbox even if it is FULL, and <code>arecvkeep()</code> - to retrieve a message from a mailbox but the box will not switch to EMPTY - so other receivers can grab the same message.</p>
</div>
<div class="ulist data-line-688">
<ul>
<li class="data-line-688">
<p>Mailbox service can be enabled/disabled in <code>kconfig.h</code>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-690">
<h2 id="message_queue">12. Message Queue</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch data-line-693">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Message Queue Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write Index</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read Index</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max of Messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Count</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Owner task</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-705">
<p>As mentioned, Mailboxes and Message Queues are quite distinct not because of the message size. A queue is indeed a message passing mechanism, taking full data ownership - it is a  <em>data-centric</em> mechanism.</p>
</div>
<div class="paragraph data-line-707">
<p>For a message queue, user will provide a buffer with enough capacity (number of messages <em>x</em> message size), that will be handled as a circular <em>buffer</em>. Message queues always start empty and they <strong><em>pass by copy</em>.</strong></p>
</div>
<div class="paragraph data-line-709">
<p>The primitives for the message queue are <code>send()</code>, <code>recv()</code>, <code>asend()</code>, <code>arecv()</code>,<code>jam()</code> and <code>peek()</code>. Opposed to mailboxes which asynchronous methods are an extension, queues can be configured as either synchronous, asynchronous or both.</p>
</div>
<div class="paragraph data-line-711">
<p>Message Queues also propagate priority when blocking, and the blocking queue discipline is configured either as by priority or FIFO. This is not to be confused with the message buffering, the first message placed is the first extracted - except for the <code>jam()</code> that places a messages on the queue front. But <em>who</em> sends/receives a message is a matter of task precedence when accessing a queue.</p>
</div>
<div class="paragraph data-line-713">
<p>Note, a queue will behave asynchronously until a <code>recv()</code> is issued to an empty queue and when a <code>send()</code> is issued on a full queue. A task that blocks on a full queue will be released as soon as a reader extracts a message and vice-versa.</p>
</div>
<div class="paragraph data-line-715">
<p>This behaviour might be desirable or not. The result, anyway, is that tasks with different periods end up synchronising to the lowest rate  -  (<em>usually</em>, undesirable for real-time). After a queue blocks full, when it eventually unblocks you might had lost data - after all, a producer when blocked won&#8217;t be able to update its data. Is it the problem? Yes and no. The problem with a blocking queue is that by buffering you are reading from the past.</p>
</div>
<div class="paragraph data-line-717">
<p>Between a message that does not arrive, and one that  arrives with information that is not useful, there is no practical difference. But if a message arrives with information that will deceive your control loop to perform a wrong action - this is the worse.  </p>
</div>
<div class="ulist data-line-719">
<ul>
<li class="data-line-719">
<p>Message Queue service can be enabled/disabled in <code>kconfig.h</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1 data-line-721">
<h2 id="pump_drop_message_queue">13. "Pump-Drop" Messages</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch data-line-724">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pump-Drop Message Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocator</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Most Recent Buffer Address</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch data-line-732">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pump-Drop Buffer</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data Address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data Size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Readers Count</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-740">
<p>Pump-Drop Buffers are meant to overcome the drawbacks exposed above for message queues, based on the concept of Cyclical Asynchronous Buffers (CAB) (essentialy as found in the HARTIK kernel). This is a fully asynchronous, one-to-many mechanism, that has an implicit memory allocator for the PD-Buffers.</p>
</div>
<div class="paragraph data-line-742">
<p>Primitives for Pump-Drop buffers are:</p>
</div>
<div class="ulist data-line-744">
<ul>
<li class="data-line-744">
<p>For writer: <code>reserve()</code> and <code>pump()</code> .</p>
</li>
<li class="data-line-745">
<p>For readers: <code>fetch()</code> and <code>drop()</code>.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-748">
<p>The semantics is as follows - remember it is one writer to many readers:</p>
</div>
<div class="olist arabic data-line-750">
<ol class="arabic">
<li class="data-line-750">
<p>When the producer needs to write a new message, first it <em>reserves</em> a PD-buffer. This might already be allocated - if it is allocated but has readers, a new PD-buffer is allocated, to ensure data consistency. </p>
</li>
<li class="data-line-751">
<p>Writer now appends a message to be sent (application-dependent) and <em>pump</em> the buffer.</p>
<li class="data-line-754">
<p>After <em>pumped</em>, the PD buffer is marked as the <em>current buffer</em>. With a new PDB on the queue, the former will eventually drop to 0 readers and will be deallocated. </p>
</li>
<li class="data-line-755">
<p>A reader first 'fetches' a message PD-buffer address - what will increase the user count within a it.</p>
</li>
<li class="data-line-756">
<p>After 'having' the message, a reader 'drops the PD-buffer': the kernel checks if it was the last reader and it is not the current pd-buffer - if these two conditions are met, the buffer is deallocated. (Checking it is NOT the current PDB guarantees there is already a new PDB in the circuit so readers won't starve).</p>
</li>
</ol>
</div>
<div class="paragraph data-line-759">
<p>This mechanism guarantees the information is always updated, but no message is corrupted. The ideal pool size, thus, is simply the number of tasks + 1.</p>
</div>
<div class="ulist data-line-763">
<ul>
<li class="data-line-763">
<p>Pump-Drop Messages can be enabled/disabled in <code>kconfig.h</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1 data-line-765">
<h2 id="remarks_on_message_passing">14. Remarks on Message Passing</h2>
<div class="sectionbody">
<div class="ulist data-line-767">
<ul>
<li class="data-line-767">
<p>Strictly, the mailbox as presented is not a message passing mechanism, it is a shared memory protocol, notification-based.</p>
</li>
<li class="data-line-768">
<p>Queues involve buffer management, making them better suited for data-centric use cases like telemetry, logging, or serialisation. They can accommodate many-to-many patterns.
The intermediate asynchronous behaviour and the deep copy gives some freedom to sender-receiver - but if overused they cause bugs that are difficult finding. Avoid many-to-many communications.</p>
</li>
<li class="data-line-771">
<p>Pump-drop messages are suitable for one-to-many patterns, when the consumer is concerned on with the most recent data, not the historical of messages - like control-loops.</p>
</li>
<li class="data-line-773">
<p>For ISR employing any kind of message-passing the system programmer must use the asynchronous primitives, therefore checking for the return value.</p>
</li>
<li class="data-line-775">
<p>Named channels - i.e., channels that are exclusive for a task - can be mimetised easily on the application.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1 data-line-778">
<h2 id="pipes">15. Pipes</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch data-line-782">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pipe Control Block</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Circular Buffer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write pointer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read pointer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event "room"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event "data"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-792">
<p>Pipes transmit streams of bytes - unlike queues or mailboxes
that transmit 'objects' with a format. They are fast because data does
not move, what moves is the read/write pointer within the pipe buffer.
A writer stops its operation when the N specified bytes have been
written, or there is no more room. In the last case it goes to sleep until
a reader wakes it up after 'extracting' from the pipe.</p>
</div>
<div class="paragraph data-line-799">
<p>A reader reads until N specified bytes were read or when there is no more data. In the last case it will sleep, to be waken by a writer.</p>
</div>
<div class="paragraph data-line-801">
<p>Both one-to-many and many-to-one channels are possible - those who wake need to themselves ensure precedence.</p>
</div>
<div class="paragraph data-line-803">
<p>As on <code>V0.3.1</code>, they depend on <em>sleep-wake</em> mechanism.</p>
</div>
<div class="paragraph data-line-805">
<p>You cannot usem them within ISRs, in no occasion - if in need, a simple ring buffer is a replacement.</p>
</div>
<div class="ulist data-line-807">
<ul>
<li class="data-line-807">
<p>Pipes can be enabled/disabled in <code>kconfig.h</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1 data-line-809">
<h2 id="usage_patterns">16. Usage Patterns</h2>
<div class="sectionbody">
<div class="paragraph data-line-811">
<p>In this section some simple usage patterns are being attached. The board used to run these snippets is a Nucleo-F103RB (ARM Cortex-M3 based).</p>
</div>
<div class="sect2 data-line-814">
<h3 id="notify_with_a_mailbox">16.1. Notify with a mailbox</h3>
<div class="paragraph data-line-815">
<p>Usage: coordinate a notified task action on a combination of events</p>
</div>
<div class="listingblock data-line-816">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="c">/*@FILE main.c */
#include "kenv.h"
#include "ksch.h"
#include "application.h"

int main(void)
{
    /* environment initialisation: system clock, interrupts, gpio ....*/

	/* task creation: */

	/*parms: entry function, string label, user assigned ID, stack address, priority, bool run-to-completion */

	assert(
			kCreateTask(Task1 , "Task1" , 1, stack1 , STACKSIZE, 1,
			FALSE)==K_SUCCESS)
			;
	assert(
			kCreateTask(Task2 , "Task2" , 2, stack2 , STACKSIZE, 1,
			FALSE)==K_SUCCESS);
	assert(
	            kCreateTask(Task3 , "Task3" , 3, stack3 , STACKSIZE, 3,
	            FALSE)==K_SUCCESS);

	/* initialise kernel */

	kInit();

	/* if you end up here you probably invaded heap */
	while (1)
	;
}

/* @file application.c */

#include "application.h"

/* waiting 4 flags to be active before going */

INT stack1[STACKSIZE];
INT stack2[STACKSIZE];
INT stack3[STACKSIZE];

typedef enum
{
	TEMPERATURE = 1, HUMIDITY, CO2, FLOW
} UPDATE_t;

K_MBOX mbox;

/*** Init kernel objects here */
VOID kApplicationInit(VOID)
{
	kMboxInit(&amp;mbox, EMPTY, NULL);
}

/* this task notifies which sensors had been updated */
VOID NotifyTask(VOID)
{
	UINT32 sendFlag = 0;
	UPDATE_t updateType = 0;

	while (1)
	{   /* simple sum to switch sensor type */

			updateType = (updateType + 1);
			if (updateType &gt; 4)
			{
				updateType = 1;
			}
			switch (updateType)
			{
			case (TEMPERATURE):
				sendFlag = FLAG_TEMP_SENSOR_UPDATE;
				break;
			case (HUMIDITY):
				sendFlag = FLAG_HUM_SENSOR_UPDATE;
				break;
			case (CO2):
				sendFlag = FLAG_CO2_SENSOR_UPDATE;
				break;
			case (FLOW):
				sendFlag = FLAG_FLOW_SENSOR_UPDATE;
				break;
			default:
				break;
			}
			K_ERR err = kMboxSend(&amp;mbox, (ADDR) &amp;sendFlag, K_WAIT_FOREVER);
			kSleepUntil(2); /* every 10ms */
		}
}

/* this task stores events by OR'ing. when it matches the expected event record it expects to take an action, the storage is reset.
alternatively it could take an action whenever a single flag was active */

VOID NotifiedTask(VOID)
{
	UINT32 *rcvdFlag = 0;
	TID senderPid = 0;
	UINT32 wantedFlags = FLAG_TEMP_SENSOR_UPDATE | FLAG_HUM_SENSOR_UPDATE |
	FLAG_CO2_SENSOR_UPDATE |
	FLAG_FLOW_SENSOR_UPDATE;
	UINT32 rcvdFlags = 0;
	while (1)
	{
		 K_ERR err = kMboxRecv(&amp;mbox, (ADDR) &amp;rcvdFlag, &amp;senderPid,
				 K_WAIT_FOREVER);
		if (err == 0)
		{

			if (senderPid == 1)
			{

				rcvdFlags |= *rcvdFlag;
				if (rcvdFlags == wantedFlags)
				{
/* the term 'synchronisation' is a bit loose here. the tasks are synch'ed
since they are running back-and-forth, but the NotifiedTask() will take
an specific action after being notified 4 different sensors had eventually been
updated. it is more like ''coordination'' */

					rcvdFlags = 0; /* clear rcvd flags */
					kprintf("Task synchronized\n\r");
					/* do work */
				}
				else
				{
					kprintf("Still missing a flag\n\r");
					kBusyDelay(1);
				}
			}

		}
	}
}


VOID Task3(VOID)
{
	while (1)
	{
		kSleep(1);

	}

}</code></pre>
</div>
</div>
<div class="imageblock data-line-965">
<div class="content">
<img src="images/mboxflags.png" alt="mboxflags">
</div>
</div>
</div>
<div class="sect2 data-line-966">
<h3 id="multi_client_server_with_mailboxes">16.2. Multi-Client Server with mailboxes</h3>
<div class="paragraph data-line-968">
<p>Usage: Many-to-one command-response</p>
</div>
<div class="listingblock data-line-970">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="c">#include "application.h"


#define MAX_PAYLOAD 36

K_MBOX serverMbox;
K_MBOX clientMbox1;
K_MBOX clientMbox2;

/* Application Protocol Data Unit */
typedef struct
{
	BYTE length; /* Length of the APDU payload */
	BYTE payload[MAX_PAYLOAD]; /* APDU payload */
	K_MBOX *replyMbox; /* Pointer to the client's reply mailbox */
} APDU;


void kApplicationInit(VOID)
{
	kMboxInit(&amp;serverMbox, EMPTY, NULL);
	kMboxInit(&amp;clientMbox1, EMPTY, NULL);
	kMboxInit(&amp;clientMbox2, EMPTY, NULL);
}

/* Hello-server */
VOID Server(VOID)
{
	APDU *request, response;

	while (1)
	{
		/* Wait for a request */
		if (kMboxRecv(&amp;serverMbox, &amp;request, NULL, K_WAIT_FOREVER) == K_SUCCESS)
		{
			kprintf("Server received request: %s\n\r", request-&gt;payload);

			/* Process the request */
			response.length = snprintf((char*) response.payload,
					sizeof(response.payload), "Response to: %s",
					request-&gt;payload);

			/* Send the response back to the client's reply mailbox */
			if (kMboxSend(request-&gt;replyMbox, &amp;response, K_WAIT_FOREVER) != K_SUCCESS)
			{
				kprintf("ACK fail\n\r");
			}
		}
	}
}

/* Hello-clients */
/
VOID Client1(VOID)
{
	APDU request, *response;

	while (1)
	{
		/* Prepare the request */
		snprintf((char*) request.payload, sizeof(request.payload),
				"Hello from Client 1");
		request.length = strlen((char*) request.payload);
		request.replyMbox = &amp;clientMbox1; /* Specify the reply mailbox */

		/* Send the request to the server */
		if (kMboxSend(&amp;serverMbox, &amp;request, K_WAIT_FOREVER) == K_SUCCESS)
		{

			/* Wait for the response */
			if (kMboxRecv(&amp;clientMbox1, (ADDR*)&amp;response, NULL, K_WAIT_FOREVER)
					== K_SUCCESS)
			{
				kprintf("C1 ACK'ed %s\n\r", response-&gt;payload);
			}
			else
			{
				kprintf("1F\n\r");
			}
		}
		else
		{
			kprintf("1F\n\r");
		}
	}
	kSleepUntil(10); /* every 50ms */
}

VOID Client2(VOID)
{
	APDU request, *response;

	while (1)
	{
		/* Prepare the request */
		snprintf((char*) request.payload, sizeof(request.payload),
				"Hello from Client 2");
		request.length = strlen((char*) request.payload);
		request.replyMbox = &amp;clientMbox2; /* Specify the reply mailbox */

		/* Send the request to the server */
		if (kMboxSend(&amp;serverMbox, &amp;request, K_WAIT_FOREVER) == K_SUCCESS)
		{

			/* Wait for the response */
			if (kMboxRecv(&amp;clientMbox2, (ADDR*)&amp;response, NULL, K_WAIT_FOREVER)
					== K_SUCCESS)
			{
				kprintf("C2 ACK'ed: %s\n\r", response-&gt;payload);
			}
			else
			{
				kprintf("2FAIL\n\r");
			}
		}
		else
		{
			kprintf("2FAIL\n\r");
		}

	}
	kSleep(10); /* 50ms */
}</code></pre>
</div>
</div>
<div class="imageblock data-line-1099">
<div class="content">
<img src="images/multiclient.png" alt="multiclient">
</div>
</div>
</div>
<div class="sect2 data-line-1102">
<h3 id="monitor_like_synchronisation_barrier">16.3. Monitor-like: Synchronisation Barrier</h3>
<div class="paragraph data-line-1104">
<p>Usage: resource access/tasks coordination</p>
</div>
<div class="listingblock data-line-1106">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs data-lang="c"">#include "application.h"

K_EVENT syncEvent; /* state event				    */
UINT32 syncCounter; /* state representation        */
K_MUTEX syncMutex; /* monitor lock				    */
K_MUTEX resourceLock; /* if there is a resource */
#define SYNC_CONDITION (syncCounter&gt;=3) /* needed tasks in the barrier */

/* only one task can be active within a monitor
 they are enqueued either on the mutex or on the event
 */
static VOID synch(VOID)
{

	kMutexLock(&amp;syncMutex, K_WAIT_FOREVER);
	kprintf("Task %d  entered monitor...\n\r", K_RUNNING_TID);
	syncCounter += 1;
	if (!(SYNC_CONDITION))
	{
		kMutexUnlock(&amp;syncMutex);

		kEventSleep(&amp;syncEvent, K_WAIT_FOREVER);
		kMutexLock(&amp;resourceLock, K_WAIT_FOREVER);
		kprintf("Task %d is active in the monitor...\n\r", K_RUNNING_TID);
		kMutexUnlock(&amp;resourceLock);
	}
	else
	{
		syncCounter = 0;
		kprintf("Task %d frees the waiting queue. \n\r", K_RUNNING_TID);
		kEventWake(&amp;syncEvent);
		kMutexUnlock(&amp;syncMutex);

	}
	kprintf("Task %d leaves monitor...\n\r", K_RUNNING_TID);
}

VOID kApplicationInit(VOID)
{
	kMutexInit(&amp;syncMutex);
	kEventInit(&amp;syncEvent);
	kMutexInit(&amp;resourceLock);
	syncCounter = 0;
}

VOID Task1(VOID)
{

	while (1)
	{
		kSleep(5);
		synch();
	}
}

VOID Task2(VOID)
{
	while (1)
	{
		kSleep(8);
		synch();
	}
}

VOID Task3(VOID)
{
	while (1)
	{
		kSleep(3);
		synch();
	}

}</code></pre>
</div>
</div>
<div class="imageblock data-line-1182">
<div class="content">
<img src="images/syncbarr.png" alt="syncbarr">
</div>
</div>
</div>
<div class="sect2 data-line-1184">
<h3 id="queueing_pattern">16.4. Queueing Pattern</h3>
<div class="paragraph data-line-1186">
<p>Usage: Asynch (like) comm, serialising access, logging, monitoring</p>
</div>
<div class="listingblock data-line-1188">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">#include "application.h"
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;

INT stack1[STACKSIZE];
INT stack2[STACKSIZE];

/* sensor types */
typedef enum
{
	TEMPERATURE = 0, HUMIDITY, CO2, FLOW
} SensorType_t;

/* message sent through the queue */
typedef struct sensorMsg
{
	SensorType_t sensorType;
	INT32 sensorValue;
} Mesg_t;

#define N_MESSAGE 10
#define MESSAGE_SIZE sizeof(Mesg_t)

K_MESGQ mesgQueue;

BYTE queueBuffer[N_MESSAGE * MESSAGE_SIZE];

VOID kApplicationInit(VOID)
{
	kMesgQInit(&amp;mesgQueue, (ADDR) queueBuffer, MESSAGE_SIZE, N_MESSAGE);
}

VOID SensorRead(VOID)
{
	SensorType_t sensorType = 0;
	Mesg_t msg;
	while (1)
	{
		sensorType = rand() % 4;
		switch (sensorType)
		{
		case (TEMPERATURE):

			msg.sensorValue = rand() % 50;
			msg.sensorType = TEMPERATURE;
			break;
		case (HUMIDITY):
			msg.sensorValue = rand() % 100;
			msg.sensorType = HUMIDITY;
			break;
		case (CO2):
			msg.sensorValue = rand() % 1000;
			msg.sensorType = CO2;
			break;
		case (FLOW):
			msg.sensorValue = rand() % 10;
			msg.sensorType = FLOW;
			break;
		default:
			break;
		}
		kMesgQSend(&amp;mesgQueue, &amp;msg, K_WAIT_FOREVER);
        kSleepUntil(2); /* every 10ms */
	}
}

VOID SensorLogging(VOID)
{
	Mesg_t recvMesg;
	while (1)
	{
	    kMesgQRecv(&amp;mesgQueue, &amp;recvMesg, K_WAIT_FOREVER);
		{
        /* pretend printf is the logging method */
			if (recvMesg.sensorType == TEMPERATURE)
				kprintf("Temperature Sensor update: %lu C\n\r",
						recvMesg.sensorValue);
			if (recvMesg.sensorType == HUMIDITY)
				kprintf("Humidity Sensor update: %lu%% \n\r",
						recvMesg.sensorValue);
			if (recvMesg.sensorType == CO2)
				kprintf("CO2 Sensor update: %lu ppm\n\r", recvMesg.sensorValue);
			if (recvMesg.sensorType == FLOW)
				kprintf("FLOW Sensor update: %lu liters/min\n\r", recvMesg.sensorValue);

		}
	}
}


/* why enqueue and not log when reading? to not loose track, events are buffered and log happens on another task */</code></pre>
</div>
</div>
<div class="imageblock data-line-1284">
<div class="content">
<img src="images/queuing.png" alt="queuing">
</div>
</div>
</div>
<div class="sect2 data-line-1287">
<h3 id="event_flagsevent_groups">16.5. Event Flags/Event Groups</h3>
<div class="paragraph data-line-1289">
<p>Usage: multi-condition broadcast, notification, observer pattern</p>
</div>
<div class="paragraph data-line-1291">
<p>Here is one of the many ways to implement multi-condition synchronisation, so-called event groups - with set/wait (or get)/clear. This approach use sleep/wake associated to an integer.</p>
</div>
<div class="listingblock data-line-1293">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">#include "application.h"
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;

INT stack1[STACKSIZE];
INT stack2[STACKSIZE];
INT stack3[STACKSIZE];
INT stack4[STACKSIZE];

#define MAX_FLAGS 32
#define FLAG_1 (1U &lt;&lt; 0) /* subject 1 */
#define FLAG_2 (1U &lt;&lt; 1) /* subject 2 */
#define FLAG_3 (1U &lt;&lt; 2) /* subject 3 */

K_EVENT eventGroup;
K_MUTEX flagMutex; /* lock for protecting the flag variable */
static volatile UINT32 eventFlags = 0U; /*  event state representation */

VOID kApplicationInit(VOID)
{
	kEventInit(&amp;eventGroup);
	kMutexInit(&amp;flagMutex);
}

/* set flags (publish/notify) */
VOID setEventFlags(uint32_t flagMask)
{
	kMutexLock(&amp;flagMutex, K_WAIT_FOREVER);
	eventFlags |= flagMask;
	kMutexUnlock(&amp;flagMutex);

	kEventWake(&amp;eventGroup);
}

/* subscribe/observe */
VOID waitForEventFlags(UINT32 flagMask, BOOL all) /* ALL or ANY */
{
		/*go to sleep */
		SLEEP:
		kEventSleep(&amp;eventGroup, K_WAIT_FOREVER);

		/* a taks wakes here  */
        /* CR: either use a mutex or a disable all irqs (preferable) */
		kMutexLock(&amp;flagMutex, K_WAIT_FOREVER);
		UINT32 currentFlags = eventFlags; /* temp copy */
		/* check */
		if ((all &amp;&amp; ((currentFlags &amp; flagMask) == flagMask)) || /* all flags */
		(!all &amp;&amp; (currentFlags &amp; flagMask))) /* any flags */
		{
			kMutexUnlock(&amp;flagMutex);
			return; /* good to go */
		}
		kMutexUnlock(&amp;flagMutex); /* nope, get back sleeping */
	    goto SLEEP;
}

VOID clearEventFlags(UINT32 flagMask)
{
	kMutexLock(&amp;flagMutex, K_WAIT_FOREVER);
	eventFlags &amp;= ~flagMask;
	kMutexUnlock(&amp;flagMutex);
}

VOID Task1(VOID) /* the setter, highest priority task  */
{
	while (1)
	{
		kSleep(1);
		setEventFlags(FLAG_1);
		setEventFlags(FLAG_2);
		kSleep(20);
		setEventFlags(FLAG_3);
	}
}

VOID Task2(VOID) /* waits for all flags */
{

	while (1)
	{
		waitForEventFlags(FLAG_1 | FLAG_2 | FLAG_3, TRUE); /* all flags */
		/* callback(); */
		kprintf("T2: got all flags \n\r");
		clearEventFlags(FLAG_1 | FLAG_2 | FLAG_3); /*clear*/
	}
}

VOID Task3(VOID) /* waits for any flags */
{
	while (1)
	{
		waitForEventFlags(FLAG_1 | FLAG_2, FALSE);
		/* callback(FLAG_1); or callback(FLAG_2); */
		kprintf("T3: At least one flag is set!\n\r");
		clearEventFlags(FLAG_1 | FLAG_2);
	}
}


VOID Task4(VOID) /* just want flag 3*/
{
	while (1)
	{
		waitForEventFlags(FLAG_3, TRUE);
		/* callback(); */
		kprintf("T4: FLAG_3 is up!\n\r");
		clearEventFlags(FLAG_3);
	}

}</code></pre>
</div>
</div>
<div class="imageblock data-line-1405">
<div class="content">
<img src="images/eventflags.png" alt="eventflags">
</div>
</div>
<hr>
<div class="paragraph data-line-1409">
<p><a href="mailto:tony@kernel0.org">tony@kernel0.org</a></p>
</div>
</div>
</div>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>
